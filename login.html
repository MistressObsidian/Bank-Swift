<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Login â€¢ Shenzhenswift</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:#f6f7fb;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
  .card{background:#fff;border-radius:16px;padding:32px 28px 28px;box-shadow:0 10px 30px rgba(0,0,0,.12);width:min(420px,94vw);position:relative}
  .brand{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand h1{font-size:22px;color:#1e3c72;font-weight:700}
  .brand a{text-decoration:none;color:#1e3c72;font-weight:600;font-size:14px}
  h2{margin:8px 0 18px;color:#1e3c72;font-size:20px}
  .form-group{margin-bottom:14px;display:flex;flex-direction:column}
  label{font-weight:600;margin:0 0 6px}
  input{padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;transition:border-color .2s}
  input:focus{outline:none;border-color:#667eea}
  .btn{width:100%;padding:14px 16px;margin-top:4px;background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;font-weight:600;font-size:15px;border:none;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:.25s}
  .btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(102,126,234,.3)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .links{display:flex;justify-content:space-between;align-items:center;margin-top:14px;font-size:14px}
  .links a{text-decoration:none;color:#1e3c72;font-weight:600}
  .alert{display:none;margin:10px 0;padding:10px 12px;border-radius:8px;font-size:14px}
  .alert.show{display:block}
  .alert.error{background:#fde8e8;color:#b91c1c;border:1px solid #fecaca}
  .alert.ok{background:#d1fae5;color:#047857;border:1px solid #a7f3d0}
  .spinner{width:16px;height:16px;border:3px solid #fff;border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @media (max-width:500px){.card{padding:24px 6vw}}
</style>
</head>
<body>
<script src="common.js"></script>
<script>
function showAlert(msg){const el=document.getElementById('loginAlert');el.textContent=msg;el.classList.add('show');}
function clearAlert(){const el=document.getElementById('loginAlert');el.textContent='';el.classList.remove('show');}
document.getElementById('loginForm').addEventListener('submit', async e=>{
  e.preventDefault(); clearAlert();
  const btn=document.getElementById('loginBtn');
  const email=document.getElementById('loginEmail').value.trim().toLowerCase();
  const password=document.getElementById('loginPassword').value;
  if(!email||!password){showAlert('Enter email and password.');return;}
  btn.disabled=true; btn.innerHTML='Authenticating <span class="spinner"></span>';
  let authenticated=false;
  try {
    // 1) SheetDB lookup
    const url=`${SHEETDB_API_URL}/search?formType=Registration&email=${encodeURIComponent(email)}&casesensitive=false`;
    const res=await fetch(url,{headers:{Authorization:`Bearer ${SHEETDB_API_TOKEN}`}});
    if(res.ok){
      const rows=await res.json();
      if(Array.isArray(rows)&&rows.length){
        const row=rows[0];
        if(!row.password || row.password===password){
          authenticated=true;
          sessionStorage.setItem('loggedInUser', JSON.stringify({
            name: row.fullname || email.split('@')[0],
            email,
            isAuthenticated:true,
            registrationDate: row.date || new Date().toISOString(),
            loginTime: new Date().toISOString()
          }));
        }
      }
    }
    // 2) Fallback internal API
    if(!authenticated){
      const apiRes=await fetch(`${API_BASE}/api/login`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email,password})
      });
      if(apiRes.ok){
        const data=await apiRes.json();
        if(data && data.user){
          authenticated=true;
          sessionStorage.setItem('loggedInUser', JSON.stringify({
            name:data.user.name,
            email:data.user.email,
            isAuthenticated:true,
            registrationDate:data.user.createdAt||new Date().toISOString(),
            loginTime:new Date().toISOString()
          }));
        }
      }
    }
    if(!authenticated){showAlert('Invalid credentials.');}
    else { window.location.href='dashboard.html'; }
  } catch {
    showAlert('Login failed. Try again.');
  } finally {
    btn.disabled=false; btn.textContent='Login';
  }
});
</script>
</body>
</html>
