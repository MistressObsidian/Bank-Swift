<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portfolio • Bank Swift</title>
  <link rel="stylesheet" href="ui.css" />
  <link rel="icon" href="bank-swift.svg" type="image/svg+xml" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --brand:#1e3c72; --brand2:#2a5298; --accent1:#667eea; --accent2:#764ba2;
      --bg:#f6f7fb; --card:#ffffff; --text:#333; --muted:#666; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:linear-gradient(135deg,var(--brand) 0%,var(--brand2) 100%);color:#fff;padding:1rem 0;position:fixed;width:100%;top:0;z-index:1000;backdrop-filter:blur(10px)}
    nav{display:flex;justify-content:space-between;align-items:center}
  .logo{display:flex;align-items:center;gap:.6rem;font-size:1.4rem;font-weight:800;background:linear-gradient(45deg,#fff,#e0e7ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.3px}
  .logo img{height:42px;width:auto;display:block}
    .nav-links{display:flex;list-style:none;gap:1.5rem}
    .nav-links a{color:#fff;text-decoration:none;transition:.3s;font-weight:600;position:relative}
    .nav-links a:hover{color:#e0e7ff;transform:translateY(-2px)}
    .btn{padding:10px 18px;border-radius:12px;text-decoration:none;font-weight:700;transition:.3s;border:2px solid transparent;cursor:pointer;position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;font-size:.95rem}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);transition:left .5s}
    .btn:hover::before{left:100%}
    .btn-primary{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:#fff;box-shadow:0 6px 20px rgba(118,75,162,.25)}
    .btn-action{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 6px 18px rgba(102,126,234,.28);font-weight:800}
    main{padding-top:96px}
    .page-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:18px 0 14px}
    .page-title{font-size:1.6rem;font-weight:800;color:var(--brand);letter-spacing:.2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar .search{width:320px;max-width:60vw;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    .grid{display:grid;gap:18px}
    @media (min-width:700px){.grid.cols-3{grid-template-columns:repeat(3,1fr)} .grid.cols-2{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .card h3{margin-bottom:8px;color:var(--brand);font-size:1.05rem}
    .kpi{display:flex;align-items:baseline;gap:10px}
    .kpi .value{font-size:1.8rem;font-weight:800}
    .kpi .muted{color:var(--muted);font-size:.9rem}
    .accounts{display:grid;gap:10px}
    .account-row{padding:12px;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:space-between;background:#fff}
    .account-row .left{display:flex;align-items:center;gap:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;color:var(--accent1);background:#eef2ff}
    .amount{font-weight:800}
    .tx-list{display:grid;gap:10px}
    .tx{display:grid;grid-template-columns:1fr auto;gap:6px 10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .tx .name{font-weight:700}
    .tx .meta{color:var(--muted);font-size:.9rem}
    .tx .delta.pos{color:#047857;font-weight:800}
    .tx .delta.neg{color:#b91c1c;font-weight:800}
    .footer-space{height:24px}
  </style>
</head>
<body>
  <script src="common.js"></script>
  <script>
// Ensure SheetDB constants originate from common.js only
(async function(){
  // Migrate legacy sessionStorage key
  try { if(!localStorage.getItem('bs-user')){ const legacy = sessionStorage.getItem('loggedInUser'); if(legacy){ localStorage.setItem('bs-user', legacy); sessionStorage.removeItem('loggedInUser'); } } } catch {}
  let user=null; try{user=JSON.parse(localStorage.getItem('bs-user')||'null');}catch{}
  if(!user||user.isAuthenticated!==true){window.location.href='login.html';return;}
  // balances
  try{
  const res=await fetch(`https://app-cold-paper-96026916.dpl.myneon.app/users?email=eq.${encodeURIComponent(user.email)}`);
    if(res.ok){
      const rows=await res.json();
      if(Array.isArray(rows)&&rows.length){
        if(rows[0].baseAvailable) BASE_AVAILABLE=Number(rows[0].baseAvailable);
        if(rows[0].totalBalance) TOTAL_BALANCE=Number(rows[0].totalBalance);
      }
    }
  }catch{}
  // rebuild UI (existing code continues)...
})();
</script>
  <header>
    <div class="container">
      <nav>
  <div class="logo" aria-label="Bank Swift">
    <span style="height:42px;width:42px;display:inline-flex;">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="logoGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#667eea"/>
            <stop offset="60%" stop-color="#764ba2"/>
            <stop offset="100%" stop-color="#8b5cf6"/>
          </linearGradient>
          <linearGradient id="logoGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#06b6d4"/>
            <stop offset="100%" stop-color="#4facfe"/>
          </linearGradient>
          <linearGradient id="logoGrad3" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#f093fb" stop-opacity="0.8"/>
            <stop offset="100%" stop-color="#f5576c" stop-opacity="0.8"/>
          </linearGradient>
        </defs>
        <path fill="url(#logoGrad1)" d="M6 10 L34 32 L6 54 Z"/>
        <path fill="url(#logoGrad2)" d="M34 10 L58 32 L34 54 L22 44 L34 32 L22 20 Z"/>
        <path fill="url(#logoGrad3)" d="M6 10 L34 32 L22 44 L6 54 Z" opacity="0.35"/>
      </svg>
    </span>
    <span>Bank Swift</span>
  </div>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="transfer.html">Transfer</a></li>
          <li><a href="#">Cards</a></li>
          <li><a href="#">Support</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <div>
          <div class="page-title">Dashboard</div>
          <div id="userNameLine" class="subtitle" style="margin-top:4px;"></div>
          <div style="color:var(--muted); margin-top:4px;">Overview of your accounts and recent activity</div>
        </div>
        <div class="toolbar">
          <input class="search" placeholder="Search transactions, accounts…">
          <a class="btn btn-primary" href="transfer.html">New transfer</a>
        </div>
      </div>

      <section class="grid cols-3" style="margin: 10px 0 8px;" id="kpiSection"></section>

      <section class="grid cols-2" style="margin-top: 8px;" id="accountSection"></section>

      <div class="footer-space"></div>
    </div>
  </main>

  <script>
  let BASE_AVAILABLE = 127400.20;
  let TOTAL_BALANCE = 127401.78;
const API_BASE = "https://app-silent-bird-08639041.dpl.myneon.app";
const API_KEY  = "napi_d1ok7sq00spa3j33sul3o5yoz15jtb74zrts8tukqvb3ofd0hkt6plfgs69brt2f";

let user = null;

document.addEventListener("DOMContentLoaded", async () => {
  try {
    user = JSON.parse(localStorage.getItem("bs-user"));
    if (!user || !user.email) {
      window.location.href = "login.html";
      return;
    }

    document.getElementById("userNameLine").textContent = `Welcome, ${user.fullname || user.email}`;

    // Load data
    await loadBalances(user.email);
    await loadTransactions(user.email);
  } catch (err) {
    console.error("Dashboard init error:", err);
  }
  // Auto-refresh when a transfer is completed
window.addEventListener("transfer-completed", async (e) => {
  console.log("Transfer event received:", e.detail);
  await loadBalances(user.email);
  await loadTransactions(user.email);
});

// Fetch balances
async function loadBalances(email) {
  try {
    const res = await fetch(`${API_BASE}/transactions?user_email=eq.${encodeURIComponent(email)}`, {
      headers: { Authorization: `Bearer ${API_KEY}` }
    });

    if (!res.ok) throw new Error("Failed to fetch balances");
    const rows = await res.json();

    let balance = 0;
    rows.forEach(tx => {
      if (tx.type === "credit") balance += Number(tx.amount);
      if (tx.type === "debit") balance -= Number(tx.amount);
    });

    const kpiSection = document.getElementById("kpiSection");
    kpiSection.innerHTML = `
      <div class="card"><h3>Available Balance</h3>
        <div class="kpi"><span class="value">$${balance.toFixed(2)}</span>
        <span class="muted">Current Funds</span></div>
      </div>
      <div class="card"><h3>Total Transactions</h3>
        <div class="kpi"><span class="value">${rows.length}</span>
        <span class="muted">History Records</span></div>
      </div>
    `;
  } catch (err) {
    console.error("Balance error:", err);
  }
}

// Fetch recent transactions
async function loadTransactions(email) {
  try {
    const res = await fetch(`${API_BASE}/transactions?user_email=eq.${encodeURIComponent(email)}&order=created_at.desc&limit=5`, {
      headers: { Authorization: `Bearer ${API_KEY}` }
    });

    if (!res.ok) throw new Error("Failed to fetch transactions");
    const rows = await res.json();

    const accountSection = document.getElementById("accountSection");
    accountSection.innerHTML = rows.map(tx => `
      <div class="account-row">
        <div class="left">
          <div>
            <div class="name">${tx.description || "Transaction"}</div>
            <div class="meta">${new Date(tx.created_at).toLocaleString()}</div>
          </div>
        </div>
        <div class="amount ${tx.type === "credit" ? "pos" : "neg"}">
          ${tx.type === "credit" ? "+" : "-"}$${Number(tx.amount).toFixed(2)}
        </div>
      </div>
    `).join("");
  } catch (err) {
    console.error("Transaction error:", err);
  }
}
}); // <-- Add this to close the DOMContentLoaded function
</script>
</body>
</html>