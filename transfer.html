<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer Money • Bank Swift</title>
  <link rel="icon" href="bank-swift.svg" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="config.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#334155 100%);
      color:white;min-height:100vh;
    }
    body::before{
      content:'';position:fixed;inset:0;z-index:-1;
      background:radial-gradient(circle at 30% 20%,rgba(102,126,234,.15)0%,transparent 50%),
                 radial-gradient(circle at 80% 80%,rgba(139,92,246,.12)0%,transparent 50%),
                 radial-gradient(circle at 40% 60%,rgba(6,182,212,.08)0%,transparent 50%);
    }
    .container{max-width:800px;margin:0 auto;padding:40px 20px}
    .header{text-align:center;margin-bottom:2rem}
    .logo{font-size:1.5rem;font-weight:800;
      background:linear-gradient(135deg,#667eea,#764ba2);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent}
    h2{font-size:2rem;font-weight:700;margin-top:.5rem}
    .subtitle{color:rgba(255,255,255,.7);margin-top:.25rem}
    .back-btn{position:absolute;top:20px;left:20px;width:42px;height:42px;
      border-radius:50%;border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.1);backdrop-filter:blur(8px);
      color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .balance-box{background:rgba(255,255,255,.08);border-radius:16px;
      padding:1.2rem;margin:1.5rem 0;text-align:center}
    .balance-box div:first-child{font-size:.95rem;color:rgba(255,255,255,.7)}
    .balance-box div:last-child{font-size:1.5rem;font-weight:700;letter-spacing:1px}
    .transfer-method-btn{padding:14px 18px;margin:.5rem 0;width:100%;
      background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;
      border-radius:12px;font-size:15px;cursor:pointer;text-align:left;
      display:flex;align-items:center;justify-content:space-between}
    .transfer-form{display:none;margin:15px 0;padding:20px;
      border:2px solid rgba(255,255,255,.15);
      border-radius:12px;background:rgba(255,255,255,.05);
      backdrop-filter:blur(10px)}
    .transfer-form h3{margin-bottom:1rem;text-align:center;border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:.5rem}
    label{display:block;margin-bottom:6px;font-size:14px}
    .transfer-input{width:100%;padding:12px;margin-bottom:1rem;
      border:2px solid rgba(255,255,255,.2);border-radius:8px;
      background:rgba(255,255,255,.1);color:#fff}
    .transfer-input::placeholder{color:rgba(255,255,255,.5)}
    .submit-btn{background:linear-gradient(45deg,#28a745,#20c997);
      padding:14px;width:100%;border:none;border-radius:10px;
      color:#fff;font-weight:600;cursor:pointer}
    .success-modal{display:none;position:fixed;inset:0;
      background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:1000}
    .success-content{position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);background:#fff;color:#333;
      padding:30px;border-radius:12px;text-align:center;width:90%;max-width:400px}
    .success-icon{font-size:3rem;color:#28a745;margin-bottom:1rem}
    .success-details{background:#e6f9ec;padding:15px;border-radius:8px;margin:1rem 0;text-align:left}
    .detail-row{display:flex;justify-content:space-between;margin:6px 0}
    .close-btn{background:linear-gradient(45deg,#667eea,#764ba2);
     border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600}
    .message{display:none;margin-top:8px;font-size:14px;color:#ff6b6b;font-weight:600;text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="window.location.href='dashboard.html'">←</button>
    <div class="header">
      <div class="logo">Bank Swift</div>
      <h2>Transfer Money</h2>
      <p class="subtitle">Choose your preferred method</p>
    </div>

    <!-- Balance -->
    <div class="balance-box">
      <div>Available Balance</div>
      <div id="availableBalance">$0.00</div>
    </div>

    <!-- Wire Transfer -->
    <button class="transfer-method-btn" onclick="toggleForm('wireForm')">Wire Transfer <span>›</span></button>
    <div id="wireForm" class="transfer-form">
      <h3>Wire Transfer</h3>
      <form>
        <label>Recipient Name</label>
        <input type="text" name="recipientName" class="transfer-input" required>
        <label>Recipient Email</label>
        <input type="email" name="recipient_email" class="transfer-input" required>
        <label>Account Number</label>
        <input type="text" name="account_number" class="transfer-input" required>
        <label>Routing Number</label>
        <input type="text" name="routing_number" class="transfer-input" required>
        <label>Amount</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <p class="message"></p>
        <button class="submit-btn" type="submit">Submit Wire Transfer</button>
      </form>
    </div>

    <!-- EFT Transfer -->
    <button class="transfer-method-btn" onclick="toggleForm('eftForm')">EFT Transfer <span>›</span></button>
    <div id="eftForm" class="transfer-form">
      <h3>EFT Transfer</h3>
      <form>
        <label>Recipient Email</label>
        <input type="email" name="recipient_email" class="transfer-input" required>
        <label>Bank Name</label>
        <input type="text" name="bank_name" class="transfer-input" required>
        <label>Account Number</label>
        <input type="text" name="account_number" class="transfer-input" required>
        <label>Routing Number</label>
        <input type="text" name="routing_number" class="transfer-input" required>
        <label>Amount</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <p class="message"></p>
        <button class="submit-btn" type="submit">Submit EFT Transfer</button>
      </form>
    </div>

    <!-- ACH Transfer -->
    <button class="transfer-method-btn" onclick="toggleForm('achForm')">ACH Transfer <span>›</span></button>
    <div id="achForm" class="transfer-form">
      <h3>ACH Transfer</h3>
      <form>
        <label>Recipient Email</label>
        <input type="email" name="recipient_email" class="transfer-input" required>
        <label>Account Number</label>
        <input type="text" name="account_number" class="transfer-input" required>
        <label>Routing Number</label>
        <input type="text" name="routing_number" class="transfer-input" required>
        <label>Amount</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <p class="message"></p>
        <button class="submit-btn" type="submit">Submit ACH Transfer</button>
      </form>
    </div>

    <!-- BTC Transfer -->
    <button class="transfer-method-btn" onclick="toggleForm('btcForm')">Convert & Send BTC <span>›</span></button>
    <div id="btcForm" class="transfer-form">
      <h3>BTC Transfer</h3>
      <form>
        <label>Recipient Email</label>
        <input type="email" name="recipient_email" class="transfer-input" required>
        <label>BTC Address</label>
        <input type="text" name="btc_address" class="transfer-input" required>
        <label>Amount (USD)</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <p class="message"></p>
        <button class="submit-btn" type="submit">Submit BTC Transfer</button>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="success-modal">
    <div class="success-content">
      <div class="success-icon">✅</div>
      <h2>Transfer Processing!</h2>
      <div id="successDetails" class="success-details"></div>
      <button class="close-btn" onclick="goToTransactionDetails()">Continue</button>
    </div>
  </div>

<script>
let user = null;

document.addEventListener("DOMContentLoaded", () => {
  user = JSON.parse(localStorage.getItem("bs-user") || "null");
  if (!user || !user.token) {
    window.location.href = "login.html";
    return;
  }

  document.querySelectorAll(".transfer-form form").forEach(f =>
    f.addEventListener("submit", handleTransfer)
  );

  connectSSE();
});

async function handleTransfer(e) {
  e.preventDefault();
  const form = e.target;
  const formData = Object.fromEntries(new FormData(form).entries());
  const messageBox = form.querySelector(".message");

  messageBox.style.display = "none";
  messageBox.textContent = "";

  if (!formData.amount || !formData.recipient_email) {
    showError(messageBox, "Please fill in all required fields.");
    return;
  }

  // Standardized payload (backend will ignore extras if not used)
  const payload = {
    sender_email: user.email,
    recipient_email: formData.recipient_email,
    amount: parseFloat(formData.amount),
    account_number: formData.account_number || null,
    routing_number: formData.routing_number || null,
    bank_name: formData.bank_name || null,
    btc_address: formData.btc_address || null,
    recipient_name: formData.recipientName || null,
    method: form.closest(".transfer-form").id
  };

  try {
    const tx = await window.bsApiFetch(",/transfers", {
      method: "POST",
      body: JSON.stringify(payload)
    });

    document.getElementById("successModal").style.display = "block";
    document.getElementById("successDetails").innerHTML = `
      <div class="detail-row"><span>Recipient</span><span>${payload.recipient_email}</span></div>
      <div class="detail-row"><span>Amount</span><span>$${Number(payload.amount).toFixed(2)}</span></div>
      <div class="detail-row"><span>Status</span><span>${tx.status || "completed"}</span></div>
    `;

    localStorage.setItem("last-transfer", JSON.stringify(tx));
    window.dispatchEvent(new CustomEvent("transfer-completed", { detail: payload }));

    form.reset();
  } catch (err) {
    console.error("Transfer error:", err);
    showError(messageBox, err.message || "Transfer failed");
  }
}

function showError(el, msg) {
  el.style.display = "block";
  el.textContent = msg;
}

function connectSSE() {
  const evtSource = new EventSource(`${window.API_BASE}/stream/user/${user.id}?token=${user.token}`);
  evtSource.onmessage = e => {
    const profile = JSON.parse(e.data);
    document.getElementById("availableBalance").textContent = `$${Number(profile.baseavailable).toFixed(2)}`;
    user = { ...user, ...profile };
    localStorage.setItem("bs-user", JSON.stringify(user));
  };
}

function goToTransactionDetails() {
  window.location.href = "transaction.html";
}

function toggleForm(id) {
  document.querySelectorAll(".transfer-form").forEach(f => f.style.display = "none");
  document.getElementById(id).style.display = "block";
}
</script>
</body>
</html>
