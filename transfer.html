<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer Money • Bank Swift</title>
  <link rel="icon" href="bank-swift.svg" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="config.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#334155 100%);
      color:white;min-height:100vh;
    }
    body::before{
      content:'';position:fixed;inset:0;z-index:-1;
      background:radial-gradient(circle at 30% 20%,rgba(102,126,234,.15)0%,transparent 50%),
                 radial-gradient(circle at 80% 80%,rgba(139,92,246,.12)0%,transparent 50%),
                 radial-gradient(circle at 40% 60%,rgba(6,182,212,.08)0%,transparent 50%);
    }
    .container{max-width:800px;margin:0 auto;padding:40px 20px}
    .header{text-align:center;margin-bottom:2rem}
    .logo{font-size:1.5rem;font-weight:800;
      background:linear-gradient(135deg,#667eea,#764ba2);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    h2{font-size:2rem;font-weight:700;margin-top:.5rem}
    .subtitle{color:rgba(255,255,255,.7);margin-top:.25rem}
    .back-btn{position:absolute;top:20px;left:20px;width:42px;height:42px;
      border-radius:50%;border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.1);backdrop-filter:blur(8px);
      color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .balance-box{background:rgba(255,255,255,.08);border-radius:16px;
      padding:1.2rem;margin:1.5rem 0;text-align:center}
    .balance-box div:first-child{font-size:.95rem;color:rgba(255,255,255,.7)}
    .balance-box div:last-child{font-size:1.5rem;font-weight:700;letter-spacing:1px}
    .transfer-method-btn{padding:14px 18px;margin:.5rem 0;width:100%;
      background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;
      border-radius:12px;font-size:15px;cursor:pointer;text-align:left;
      display:flex;align-items:center;justify-content:space-between}
    .transfer-form{display:none;margin:15px 0;padding:20px;
      border:2px solid rgba(255,255,255,.15);
      border-radius:12px;background:rgba(255,255,255,.05);
      backdrop-filter:blur(10px)}
    .transfer-form h3{margin-bottom:1rem;text-align:center;border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:.5rem}
    label{display:block;margin-bottom:6px;font-size:14px}
    .transfer-input{width:100%;padding:12px;margin-bottom:1rem;
      border:2px solid rgba(255,255,255,.2);border-radius:8px;
      background:rgba(255,255,255,.1);color:#fff}
    .transfer-input::placeholder{color:rgba(255,255,255,.5)}
    .submit-btn{background:linear-gradient(45deg,#28a745,#20c997);
      padding:14px;width:100%;border:none;border-radius:10px;
      color:#fff;font-weight:600;cursor:pointer;position:relative;overflow:hidden}
    .success-modal{display:none;position:fixed;inset:0;
      background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:1000}
    .success-content{position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);background:#fff;color:#333;
      padding:30px;border-radius:12px;text-align:center;width:90%;max-width:400px}
    .success-icon{font-size:3rem;color:#28a745;margin-bottom:1rem}
    .success-details{background:#e6f9ec;padding:15px;border-radius:8px;margin:1rem 0;text-align:left}
    .detail-row{display:flex;justify-content:space-between;margin:6px 0}
    .close-btn{background:linear-gradient(45deg,#667eea,#764ba2);
      border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600}
    /* Loading overlay */
    .loading-overlay{display:none;position:fixed;inset:0;z-index:2000;
      background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);
      display:flex;align-items:center;justify-content:center}
    .loading-spinner{width:60px;height:60px;border:5px solid rgba(255,255,255,.3);
      border-top:5px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="window.location.href='dashboard.html'">←</button>
    <div class="header">
      <div class="logo">Bank Swift</div>
      <h2>Transfer Money</h2>
      <p class="subtitle">Choose your preferred method</p>
    </div>

    <!-- Balance -->
    <div class="balance-box">
      <div>Available Balance</div>
      <div id="availableBalance">$0.00</div>
    </div>

    <!-- Method Buttons -->
    <button class="transfer-method-btn" onclick="toggleForm('wireForm')">Wire Transfer <span>›</span></button>
    <div id="wireForm" class="transfer-form">
      <h3>Wire Transfer</h3>
      <form onsubmit="handleTransfer(event)">
        <label>Recipient Email</label>
        <input type="email" name="recipient" class="transfer-input" required>
        <label>Account Number</label>
        <input type="text" name="account" class="transfer-input" required>
        <label>Routing Number</label>
        <input type="text" name="routing" class="transfer-input" required>
        <label>Amount</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <button class="submit-btn" type="submit">Submit Wire Transfer</button>
      </form>
    </div>

    <button class="transfer-method-btn" onclick="toggleForm('eftForm')">EFT Transfer <span>›</span></button>
    <div id="eftForm" class="transfer-form">
      <h3>EFT Transfer</h3>
      <form onsubmit="handleTransfer(event)">
        <label>Recipient Email</label>
        <input type="email" name="recipient" class="transfer-input" required>
        <label>Bank Name</label>
        <input type="text" name="bank" class="transfer-input" required>
        <label>Account Number</label>
        <input type="text" name="account" class="transfer-input" required>
        <label>Routing Number</label>
        <input type="text" name="routing" class="transfer-input" required>
        <label>Amount</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <button class="submit-btn" type="submit">Submit EFT Transfer</button>
      </form>
    </div>

    <button class="transfer-method-btn" onclick="toggleForm('achForm')">ACH Transfer <span>›</span></button>
    <div id="achForm" class="transfer-form">
      <h3>ACH Transfer</h3>
      <form onsubmit="handleTransfer(event)">
        <label>Recipient Email</label>
        <input type="email" name="recipient" class="transfer-input" required>
        <label>Account Number</label>
        <input type="text" name="account" class="transfer-input" required>
        <label>Routing Number</label>
        <input type="text" name="routing" class="transfer-input" required>
        <label>Amount</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <button class="submit-btn" type="submit">Submit ACH Transfer</button>
      </form>
    </div>

    <button class="transfer-method-btn" onclick="toggleForm('btcForm')">Convert & Send BTC <span>›</span></button>
    <div id="btcForm" class="transfer-form">
      <h3>BTC Transfer</h3>
      <form onsubmit="handleTransfer(event)">
        <label>Recipient Email</label>
        <input type="email" name="recipient" class="transfer-input" required>
        <label>BTC Address</label>
        <input type="text" name="btcAddress" class="transfer-input" required>
        <label>Amount (USD)</label>
        <input type="number" name="amount" class="transfer-input" min="1" step="0.01" required>
        <button class="submit-btn" type="submit">Submit BTC Transfer</button>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="success-modal">
    <div class="success-content">
      <div class="success-icon">✅</div>
      <h2>Transfer Processing!</h2>
      <div id="successDetails" class="success-details"></div>
      <button class="close-btn" onclick="goToTransactionDetails()">Continue</button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script>
  let user = null;

  document.addEventListener("DOMContentLoaded", () => {
    user = JSON.parse(localStorage.getItem("bs-user") || "null");
    if (!user || !user.token) {
      window.location.href = "login.html";
      return;
    }

    document.querySelectorAll(".transfer-form").forEach(f =>
      f.addEventListener("submit", handleTransfer)
    );

    // Start SSE for live balance updates
    connectSSE();
  });

  async function handleTransfer(e) {
    e.preventDefault();
    const form = e.target;
    const formData = Object.fromEntries(new FormData(form).entries());

    const amount = parseFloat(formData.amount);
    const recipient = (formData.recipient || "").toLowerCase();

    if (!amount || !recipient) {
      alert("Please fill in all required fields.");
      return;
    }

    try {
      // 1. Create transfer
      const authUser = user;
      const res = await fetch(`${window.API_BASE}/transfers`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authUser?.token || ''}`
        },
        body: JSON.stringify({ recipient, amount })
      });
      if (!res.ok) throw new Error("Transfer failed");
      const tx = await res.json();

      // 2. Record debit for sender
      await fetch(`${window.API_BASE}/transactions`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${user.token}` },
        body: JSON.stringify({ user_email: user.email, type: "debit", amount, description: `Transfer to ${recipient}` })
      });

      // 3. Record credit for recipient
      await fetch(`${window.API_BASE}/transactions`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${user.token}` },
        body: JSON.stringify({ user_email: recipient, type: "credit", amount, description: `Received from ${user.email}` })
      });

      // 4. Show success modal (with live balance if available)
      document.getElementById("successModal").style.display = "block";
      const balanceDisplay = user.baseavailable
        ? `<div class="detail-row"><span>New Balance</span><span>$${Number(user.baseavailable).toFixed(2)}</span></div>`
        : "";

      document.getElementById("successDetails").innerHTML = `
        <div class="detail-row"><span>Recipient</span><span>${recipient}</span></div>
        <div class="detail-row"><span>Amount</span><span>$${amount.toFixed(2)}</span></div>
        <div class="detail-row"><span>Status</span><span>${tx.status || 'completed'}</span></div>
        ${balanceDisplay}
      `;

      // 5. Save last transfer for receipt page
      localStorage.setItem("last-transfer", JSON.stringify(tx));

      // 6. Dispatch event so dashboard refreshes
      window.dispatchEvent(new CustomEvent("transfer-completed", { detail: { sender: user.email, recipient, amount } }));

      form.reset();
    } catch (err) {
      console.error(err);
      alert(err.message || "Transfer failed");
    }
  }

  function connectSSE() {
    const evtSource = new EventSource(`${window.API_BASE}/stream/user/${user.id}?token=${user.token}`);
    evtSource.onmessage = e => {
      const profile = JSON.parse(e.data);

      // Update balance box
      document.getElementById("availableBalance").textContent =
        `$${Number(profile.baseavailable).toFixed(2)}`;

      // Update cached user
      user = { ...user, ...profile };
      localStorage.setItem("bs-user", JSON.stringify(user));

      // If success modal is open, also update balance row
      if (document.getElementById("successModal").style.display === "block") {
        const balanceRow = document.querySelector("#successDetails .detail-row:last-child");
        if (balanceRow && balanceRow.firstChild.textContent === "New Balance") {
          balanceRow.lastChild.textContent = `$${Number(profile.baseavailable).toFixed(2)}`;
        }
      }
    };
  }

  function goToTransactionDetails() {
    window.location.href = "transaction.html";
  }
</script>
</body>
</html>
