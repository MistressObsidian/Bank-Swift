<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transfer Money - Shenzhenswift</title>
  <style>
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#333}
    .container{max-width:900px;margin:40px auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .row{display:grid;gap:12px;grid-template-columns:1fr} @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}
    label{font-weight:700;font-size:.95rem} input,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px}
    .btn{margin-top:12px;padding:12px 16px;border:none;border-radius:10px;background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;font-weight:800;cursor:pointer}
    .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000;align-items:center;justify-content:center}
    .receipt{width:min(420px,90vw);background:#fff;border-radius:16px;padding:18px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .spinner{width:28px;height:28px;border:3px solid #e5e7eb;border-top:3px solid #667eea;border-radius:50%;animation:spin .9s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .payment-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1100;align-items:center;justify-content:center}
    .payment-card{width:min(460px,92vw);background:#fff;border-radius:16px;padding:18px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .flex{display:flex;gap:10px;flex-wrap:wrap} .btn-outline{background:#fff;color:#764ba2;border:2px solid #d9ddff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .muted{color:#666} .status-pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:.8rem;color:#065f46;background:#d1fae5;border:1px solid #a7f3d0}
  </style>
</head>
<body>
  <div class="container">
    <h2>Transfer</h2>
    <form id="transferForm">
      <div class="row">
        <div>
          <label>From account
            <input id="fromAccount" placeholder="Everyday Checking • •••3482" required />
          </label>
        </div>
        <div>
          <label>To account
            <input id="toAccount" placeholder="Savings • •••9015 or External" required />
          </label>
        </div>
        <div>
          <label>Amount
            <input id="amount" type="number" min="1" step="0.01" placeholder="1000.00" required />
          </label>
        </div>
        <div>
          <label>Network / Type
            <select id="network">
              <option>Internal Transfer</option>
              <option>ACH Transfer</option>
              <option>Wire Transfer</option>
              <option>EFT Transfer</option>
            </select>
          </label>
        </div>
      </div>
      <button class="btn" type="submit" id="submitBtn">Send</button>
    </form>
  </div>

  <!-- Loading/Receipt Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="receipt" id="receipt">
      <div style="display:flex;align-items:center;margin-bottom:8px;">
        <div class="spinner"></div>
        <div style="font-weight:800;">Processing transfer…</div>
      </div>
      <div id="rStatus" class="status-pill">Pending</div>
      <div style="margin-top:10px;">
        <div><b>Amount:</b> <span id="rAmount">$0.00</span></div>
        <div><b>From:</b> <span id="rFrom">—</span></div>
        <div><b>To:</b> <span id="rTo">—</span></div>
        <div><b>Network:</b> <span id="rNet">—</span></div>
        <div><b>Reference:</b> <span id="rRef">—</span></div>
        <div class="muted" style="margin-top:8px;">Complete the required payment to post this transfer.</div>
      </div>
    </div>
  </div>

  <!-- Payment required modal -->
  <div id="paymentModal" class="payment-modal" role="dialog" aria-modal="true">
    <div class="payment-card">
      <h3>Payment required</h3>
      <div class="muted" style="margin-top:6px;">To complete this transfer, please pay the required amount below.</div>
      <div style="margin-top:12px;"><b>Amount to pay:</b> <span id="payAmount">$0.00</span></div>
      <div style="margin-top:12px;">
        <label>Payment method
          <select id="payMethod" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px;">
            <option value="card">Card</option>
            <option value="bank">Bank debit</option>
          </select>
        </label>
      </div>
      <div class="flex" style="margin-top:14px;">
        <button id="payNowBtn" class="btn" type="button">Pay now</button>
        <button id="cancelPayBtn" class="btn-outline" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    function currency(n){ try{return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'})}catch{return `$${n}`}}
    function genRef(){ return 'TXN' + Math.random().toString().slice(2,10) + Date.now().toString().slice(-4); }

    const KEY = 'initiatedTransactions';
    function getTxList(){ try{ return JSON.parse(sessionStorage.getItem(KEY) || '[]'); }catch{return []} }
    function setTxList(list){ sessionStorage.setItem(KEY, JSON.stringify(list)); }

    // Create transaction, show processing, then require payment to complete
    document.getElementById('transferForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const user = JSON.parse(sessionStorage.getItem('loggedInUser') || '{}');
      const amount = Number(document.getElementById('amount').value || 0);
      const from = (document.getElementById('fromAccount').value || '').trim() || 'Everyday Checking •••3482';
      const to = (document.getElementById('toAccount').value || '').trim() || 'External Account';
      const network = document.getElementById('network').value;
      const ref = genRef();

      // Create PENDING tx
      const tx = {
        email: user.email,
        source: 'transfer',
        name: 'Transfer',
        type: network,
        amount: amount,
        delta: amount ? `- ${currency(amount)}` : undefined,
        from, to,
        status: 'Pending',
        reference: ref,
        dateISO: new Date().toISOString(),
        network,
        paid: false
      };
      const list = getTxList();
      list.unshift(tx);
      setTxList(list);

      // Show processing overlay
      document.getElementById('rAmount').textContent = currency(amount);
      document.getElementById('rFrom').textContent = from;
      document.getElementById('rTo').textContent = to;
      document.getElementById('rNet').textContent = network;
      document.getElementById('rRef').textContent = ref;
      document.getElementById('loadingOverlay').style.display = 'flex';

      // After brief processing, show payment required modal
      setTimeout(()=>{
        document.getElementById('loadingOverlay').style.display = 'none';
        openPaymentModal(ref, amount);
      }, 1500);
    });

    // Payment modal logic
    function openPaymentModal(ref, amount){
      const modal = document.getElementById('paymentModal');
      const payAmt = document.getElementById('payAmount');
      payAmt.textContent = currency(amount); // required payment equals transfer amount
      modal.style.display = 'flex';

      // Wire buttons
      const payBtn = document.getElementById('payNowBtn');
      const cancelBtn = document.getElementById('cancelPayBtn');

      const payHandler = ()=>{
        // Mark tx as Completed + paid, then redirect to details
        const list = getTxList();
        const idx = list.findIndex(t => (t.reference||t.ref||t.id) === ref);
        if (idx !== -1) {
          list[idx].paid = true;
          list[idx].paidAt = new Date().toISOString();
          list[idx].status = 'Completed';
        }
        setTxList(list);
        modal.style.display = 'none';
        window.location.href = `transaction-details.html?ref=${encodeURIComponent(ref)}`;
      };

      const cancelHandler = ()=>{ modal.style.display = 'none'; };

      payBtn.onclick = payHandler;
      cancelBtn.onclick = cancelHandler;
      modal.addEventListener('click', (e)=>{ if(e.target === modal) cancelHandler(); }, { once:true });
    }
  </script>
</body>
</html>