<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transactions · Bank Swift</title>
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="ui.css" />
  <link rel="icon" href="bank-swift.svg" type="image/svg+xml" />
  <style>
    :root { --bg:#0d0f14; --panel:#141a24; --border:#1f2530; --ink:#eef3f8; --muted:#8aa0b9; --muted2:#7a889a; --pill:#1f2733; --accent:#2663ff; --ok:#10b981; --warn:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; min-height:100vh; }

    header { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:1rem 1.25rem; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(13,15,20,.9); backdrop-filter: blur(10px); z-index:5; }
    header h1 { font-size:1.05rem; margin:0; letter-spacing:.5px; }
    a.back-link { color:#7aa8ff; text-decoration:none; font-size:.85rem; }
    a.back-link:hover { text-decoration:underline; }

    main.layout { max-width:1100px; margin:1rem auto 2rem; padding:0 1rem; display:grid; gap:1rem; grid-template-columns: 1.05fr .95fr; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:1.1rem 1.1rem 1.25rem; }
    .panel h2 { margin:0 0 .85rem; font-size:.9rem; letter-spacing:.5px; text-transform:uppercase; color:#7d8da3; }
    .pill { background: var(--pill); padding:.35rem .6rem; border-radius:999px; font-size:.7rem; color:#9fb1c9; display:inline-block; }

    /* Left list */
    .tx-list { border:1px solid var(--border); border-radius:12px; background:#0f141d; max-height:520px; overflow:auto; }
    .tx-item { display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--border); cursor:pointer; }
    .tx-item:last-child { border-bottom:none; }
    .tx-item:hover { background:#121a22; }
    .tx-item.active { background:#182537; box-shadow: inset 3px 0 0 var(--accent); }
    .tx-left { display:flex; align-items:center; gap:10px; }
    .tx-icon { width:36px; height:36px; display:grid; place-items:center; border-radius:50%; background:#192438; color:#bcd7ff; font-weight:900; }
    .tx-title { font-weight:800; }
    .tx-meta { font-size:.8rem; color:var(--muted); }
    .tx-amount { font-weight:900; }
    .tx-amount.pos { color:#57d987; }
    .tx-amount.neg { color:#ff7b7b; }

    /* Right receipt */
    .status-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.6rem; flex-wrap:wrap; }
    .status-pill { display:inline-block; padding:.4rem .65rem; border-radius:999px; font-weight:700; font-size:.72rem; }
    .status-pill.completed { color:#0f5132; background:#d1fae5; border:1px solid #a7f3d0; }
    .status-pill.pending { color:#7a4a0c; background:#fef3c7; border:1px solid #fde68a; }

    .banner { display:flex; align-items:center; gap:.6rem; padding:.75rem .85rem; border-radius:12px; font-weight:700; margin:.35rem 0 .85rem; }
    .banner.ok { color:#91f2b4; background:#0e1a17; border:1px solid #184538; }
    .banner.warn { color:#ffd18b; background:#1a150a; border:1px solid #57421a; }
    .banner .icon { width:26px; height:26px; border-radius:50%; display:grid; place-items:center; color:#0b1; background:#14231c; }
    .banner.warn .icon { color:#f59e0b; background:#2b2112; }

    .amount-line { display:flex; align-items:baseline; gap:10px; margin:.6rem 0 1rem; flex-wrap:wrap; }
    .amount-line .label { color:var(--muted); font-size:.8rem; }
    .amount-line .value { font-size:1.55rem; font-weight:900; }

    .details-grid { display:grid; gap:.75rem; grid-template-columns:1fr; }
    @media (min-width:760px){ .details-grid { grid-template-columns:1fr 1fr; } }
    .detail { padding:.85rem; border:1px solid var(--border); border-radius:12px; background:#101826; }
    .detail .label { color:var(--muted); font-size:.7rem; margin-bottom:6px; font-weight:800; text-transform:uppercase; letter-spacing:.5px; }
    .detail .value { font-weight:800; }

    .actions { display:flex; gap:.6rem; flex-wrap:wrap; margin-top:1rem; }
    .btn { cursor:pointer; border:none; border-radius:10px; padding:.7rem 1rem; background:#1d2733; color:#e9eef5; font-size:.85rem; }
    .btn:hover { background:#233040; }
    .btn-primary { background: var(--accent); color:#fff; }
    .btn-primary:hover { background:#1f55dc; }

    .note { margin-top:18px; font-size:.8rem; color:var(--muted2); }
    .extra-detail { margin-top:.6rem; font-size:.85rem; color:#cfd8e3; }
    .extra-detail strong { font-weight:700; color:#fff; }

    @media (max-width:900px){ main.layout { grid-template-columns: 1fr; } }
    @media (max-width:520px){
      header { flex-direction:column; align-items:flex-start; }
      .btn { flex:1; justify-content:center; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Transactions</h1>
  <nav><a class="back-link" href="dashboard.html">← Back to Home</a></nav>
  </header>

  <main class="layout">
    <!-- Left: All transactions -->
    <section class="panel">
      <h2>All Transactions</h2>
      <div id="txList" class="tx-list" aria-label="All transactions"></div>
    </section>

    <!-- Right: Receipt -->
    <section class="panel">
      <h2>Receipt</h2>
      <div class="status-row">
        <span id="summaryText" class="pill">Loading…</span>
        <span id="statusPill" class="status-pill"></span>
      </div>
      <div id="statusBanner" class="banner" style="display:none;"></div>

      <div class="amount-line">
        <span class="label">Amount</span>
        <span class="value" id="amountValue">$0.00</span>
      </div>

      <div class="details-grid">
        <div class="detail">
          <div class="label">From</div>
          <div class="value" id="fromValue">—</div>
        </div>
        <div class="detail">
          <div class="label">To</div>
          <div class="value" id="toValue">—</div>
        </div>
        <div class="detail">
          <div class="label">Description</div>
          <div class="value" id="descriptionValue">—</div>
        </div>
        <div class="detail">
          <div class="label">Reference</div>
          <div class="value" id="referenceValue">—</div>
        </div>
        <div class="detail">
          <div class="label">Network</div>
          <div class="value" id="networkValue">Bank Swift Transfer</div>
        </div>
        <div class="detail">
          <div class="label">Fees</div>
          <div class="value" id="feesValue">$0.00</div>
        </div>
      </div>

      <div id="extraDetails" class="extra-detail"></div>

      <div class="actions"></div>
      <div class="note" id="txContainer"></div>
    </section>
  </main>

  <script src="config.js"></script>
  <script src="common.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.Notifications) window.Notifications.init();
      try {
        const user = JSON.parse(localStorage.getItem("bs-user"));
        if (!user || !user.token) { window.location.href = "login.html"; return; }
        loadAllTransactions();
      } catch (err) {
        console.error("Transactions init error:", err);
        document.getElementById("txContainer").textContent = "Could not load transactions.";
      }
    });

    const nameCache = new Map();
    let allTxs = [];

    async function lookupName(email, token){
      try{
        const key = (email||'').toLowerCase();
        if (!key) return null;
        if (nameCache.has(key)) return nameCache.get(key);
        const res = await fetch(`${window.API_BASE}/users/lookup?email=${encodeURIComponent(key)}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('lookup failed');
        const data = await res.json();
        nameCache.set(key, data?.fullname || null);
        return data?.fullname || null;
      } catch { return null; }
    }

    async function loadAllTransactions(){
      try{
        const user = JSON.parse(localStorage.getItem("bs-user") || "null");
        const res = await fetch(`${window.API_BASE}/transactions`, {
          headers: { Authorization: `Bearer ${user?.token || ''}` }
        });
        const text = await res.text();
        const txRows = text ? JSON.parse(text) : [];
        if (!res.ok) throw new Error(txRows?.error || `Failed to load transactions (${res.status})`);
        allTxs = Array.isArray(txRows) ? txRows : [];
        renderTxList(allTxs);

        // Preselect from localStorage or first
        let preselect = null;
        try { preselect = JSON.parse(localStorage.getItem('transfer') || 'null'); } catch {}
        if (!preselect) { try { preselect = JSON.parse(localStorage.getItem('last-transfer') || 'null'); } catch {} }
        let initial = preselect && preselect.id ? (allTxs.find(t => t.id === preselect.id) || preselect) : allTxs[0];
        if (initial) renderReceipt(initial);
        if (!allTxs.length) document.getElementById("txContainer").textContent = "No transactions found.";
      } catch(err){
        console.error('Load all transactions error:', err);
        document.getElementById("txContainer").textContent = err.message || 'Failed to load transactions';
      }
    }

    function renderTxList(list){
      const container = document.getElementById('txList');
      if (!container) return;
      container.innerHTML = '';
      if (!list || !list.length){
        container.innerHTML = `<div style="padding:12px; color:var(--muted)">No transactions</div>`;
        return;
      }
      list.forEach((tx, idx) => {
        const item = document.createElement('div');
        item.className = 'tx-item';
        const isCredit = (tx.type || '').toLowerCase() === 'credit';
        const amount = Number(tx.amount || 0);
        const prefix = isCredit ? '+' : '-';
        const signClass = isCredit ? 'pos' : 'neg';
        const when = tx.created_at ? new Date(tx.created_at).toLocaleString() : '';
        const title = tx.description || (isCredit ? 'Credit' : 'Debit');
        item.innerHTML = `
          <div class="tx-left">
            <div class="tx-icon">${isCredit ? '💰' : '💸'}</div>
            <div>
              <div class="tx-title">${title}</div>
              <div class="tx-meta">${when}</div>
            </div>
          </div>
          <div class="tx-amount ${signClass}">${prefix}$${amount.toFixed(2)}</div>
        `;
        item.addEventListener('click', () => {
          Array.from(container.children).forEach(c => c.classList.remove('active'));
          item.classList.add('active');
          renderReceipt(tx);
        });
        if (idx === 0) item.classList.add('active');
        container.appendChild(item);
      });
    }

    async function renderReceipt(tx) {
      const user = JSON.parse(localStorage.getItem("bs-user") || "null");
      const currentEmail = (user?.email || "").toLowerCase();

      const statusBanner = document.getElementById("statusBanner");
      const statusPill = document.getElementById("statusPill");
      const actionsDiv = document.querySelector(".actions");
      actionsDiv.innerHTML = ""; // reset actions per selection

      const amt = Number(tx.amount) || 0;
      const fees = amt * 0.235;

  // Sender/receiver relative to current user (fallback to tx.type when emails are absent)
  const txType = (tx.type || '').toLowerCase();
  const isSender = ((tx.sender_email || '').toLowerCase() === currentEmail) || txType === 'debit';
  const isReceiver = ((tx.recipient_email || '').toLowerCase() === currentEmail) || txType === 'credit';

      // Status visuals
      let statusText = '';
      statusBanner.style.display = 'flex';
      if (isSender) {
        statusBanner.className = "banner ok";
        statusBanner.innerHTML = `<div class="icon">✔</div><div>Transfer Completed Successfully</div>`;
        statusPill.className = "status-pill completed";
        statusText = "Completed";
      } else if (isReceiver) {
        statusBanner.className = "banner warn";
        statusBanner.innerHTML = `<div class="icon">⏱</div><div>Pending — Payment of required fee is needed to complete this transaction</div>`;
        statusPill.className = "status-pill pending";
        statusText = "Pending (Fee Required)";
        const payBtn = document.createElement("button");
        payBtn.className = "btn btn-primary";
        payBtn.textContent = `Pay Fee ($${fees.toFixed(2)})`;
        payBtn.onclick = () => {
          localStorage.setItem("pending-fee", JSON.stringify({ amount: fees, originalTx: tx }));
          window.location.href = "pay-fee.html";
        };
        actionsDiv.appendChild(payBtn);
      } else {
        statusBanner.className = "banner warn";
        statusBanner.innerHTML = `<div class="icon">⏱</div><div>Transaction in review</div>`;
        statusPill.className = "status-pill pending";
        statusText = "Review";
      }
      statusPill.textContent = statusText;

      // Amount
      document.getElementById("amountValue").textContent = `$${amt.toFixed(2)}`;

      // Names: prefer explicit fields; fall back to user + description parsing; finally use lookup by email.
      const extractAfter = (desc, marker) => {
        if (!desc) return null;
        const d = String(desc);
        const idx = d.toLowerCase().lastIndexOf(marker);
        if (idx === -1) return null;
        return d.slice(idx + marker.length).trim();
      };

      let fromDisplay = (tx.sender_account_name || tx.sender_fullname || tx.sender_name) || null;
      let toDisplay = (tx.recipient_account_name || tx.recipient_fullname || tx.recipient_name) || null;

      // Derive from current user context and description patterns when missing
      const desc = tx.description || '';
      if (!fromDisplay || !toDisplay){
        if (txType === 'debit') {
          fromDisplay = fromDisplay || user.accountname || user.fullname || fromDisplay;
          toDisplay = toDisplay || extractAfter(desc, ' to ');
        } else if (txType === 'credit') {
          toDisplay = toDisplay || user.accountname || user.fullname || toDisplay;
          fromDisplay = fromDisplay || extractAfter(desc, ' from ');
        }
      }

      // As a last resort, try to resolve by email lookup (if emails exist and still missing)
      if ((!fromDisplay && tx.sender_email) || (!toDisplay && tx.recipient_email)){
        try{
          const [fromName, toName] = await Promise.all([
            fromDisplay ? Promise.resolve(null) : lookupName(tx.sender_email, user.token),
            toDisplay ? Promise.resolve(null) : lookupName(tx.recipient_email, user.token)
          ]);
          fromDisplay = fromDisplay || fromName;
          toDisplay = toDisplay || toName;
        } catch {}
      }

      // Final fallbacks
      fromDisplay = fromDisplay || '—';
      toDisplay = toDisplay || '—';

      document.getElementById("summaryText").textContent = `From ${fromDisplay} to ${toDisplay}`;
      document.getElementById("fromValue").textContent = fromDisplay;
      document.getElementById("toValue").textContent = toDisplay;

      // Description with status context
      const descStatus = isSender ? "Transfer Completed" : (isReceiver ? "Transfer Pending (Fee Required)" : "Transfer In Review");
      document.getElementById("descriptionValue").textContent = tx.description ? `${tx.description} — ${descStatus}` : descStatus;

      // Details
      document.getElementById("referenceValue").textContent = tx.id || tx.reference || ("TX-" + Date.now());
      document.getElementById("networkValue").textContent = "Bank Swift Transfer";
      document.getElementById("feesValue").textContent = `$${fees.toFixed(2)} (Fee Required)`;

      // Extra fields
      const extras = [];
      if (tx.account_number) extras.push(`<strong>Account #:</strong> ${tx.account_number}`);
      if (tx.routing_number) extras.push(`<strong>Routing #:</strong> ${tx.routing_number}`);
      if (tx.btc_address) extras.push(`<strong>BTC Address:</strong> ${tx.btc_address}`);
      document.getElementById("extraDetails").innerHTML = extras.join("<br>");
    }
  </script>
</body>
</html>
