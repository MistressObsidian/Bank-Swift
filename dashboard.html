<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard • Shenzhenswift</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:#f6f7fb;color:#222;min-height:100vh;padding:0 0 60px}
  header{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;z-index:1000}
  header .inner{max-width:1150px;margin:0 auto;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
  .logo{font-size:1.5rem;font-weight:800;background:linear-gradient(45deg,#fff,#e0e7ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .nav-links{list-style:none;display:flex;gap:1.5rem}
  .nav-links a{color:#fff;text-decoration:none;font-weight:600;position:relative;transition:.3s}
  .nav-links a:hover{color:#e0e7ff;transform:translateY(-2px)}
  main{padding-top:96px;max-width:1150px;margin:0 auto;padding-left:20px;padding-right:20px}
  h1{font-size:1.9rem;margin-bottom:4px}
  .subtitle{color:#666;font-size:.9rem;margin-bottom:20px}
  .kpis{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-bottom:22px}
  .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  .kpi .value{font-size:1.15rem;font-weight:700;margin-bottom:4px}
  .kpi .muted{color:#666;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
  .accounts,.recent{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px 18px 10px;margin-bottom:26px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .section-title{font-size:1.15rem;font-weight:700;margin-bottom:12px;color:#1e3c72;display:flex;justify-content:space-between;align-items:center}
  .account-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f1f3f5;font-size:.9rem}
  .account-row:last-child{border-bottom:none}
  .pill{display:inline-block;padding:4px 10px;font-size:.65rem;font-weight:800;border-radius:999px;background:#eef2ff;color:#667eea;margin-right:6px}
  .tx{display:grid;grid-template-columns:1fr auto;gap:4px;padding:10px 0;border-bottom:1px solid #f1f3f5;font-size:.85rem}
  .tx:last-child{border-bottom:none}
  .tx .delta{font-weight:700}
  .delta.pos{color:#047857}
  .delta.neg{color:#b91c1c}
  .actions a.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;border-radius:10px;font-size:.85rem;font-weight:600;text-decoration:none;color:#fff;background:linear-gradient(45deg,#667eea,#764ba2);transition:.3s}
  .actions a.btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(102,126,234,.32)}
  .back-btn{position:fixed;top:110px;left:18px;background:#fff;border:1px solid #e5e7eb;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#667eea;box-shadow:0 4px 14px rgba(0,0,0,.08);transition:.25s}
  .back-btn:hover{transform:translateX(-2px)}
  @media(max-width:720px){
    .kpis{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    .tx{grid-template-columns:1fr 60px}
    .back-btn{top:80px}
  }
</style>
</head>
<body>
<script src="common.js"></script>
<header>
  <div class="inner">
    <div class="logo">Shenzhenswift</div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="transfer.html">Transfer</a></li>
      <li><a href="#">Cards</a></li>
      <li><a href="#">Support</a></li>
    </ul>
  </div>
</header>
<main>
  <button class="back-btn" onclick="window.location.href='index.html'" title="Home">←</button>
  <h1>Dashboard</h1>
  <div id="userWelcome" class="subtitle"></div>

  <section class="kpis" id="kpiSection"></section>

  <section class="accounts" id="accountSection">
    <div class="section-title">
      <span>Accounts</span>
    </div>
    <div id="accountsBody"></div>
  </section>

  <section class="recent" id="recentSection">
    <div class="section-title">
      <span>Recent Transfers</span>
      <div class="actions">
        <a class="btn" href="transfer.html">New transfer</a>
      </div>
    </div>
    <div id="txList"></div>
  </section>
</main>
<script>
function currency(n){try{return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'})}catch{return `$${n}`}}
let BASE_AVAILABLE = 0;
let TOTAL_BALANCE = 0;
async function loadBalances(user){
  try{
    const url=`${SHEETDB_API_URL}/search?formType=Registration&email=${encodeURIComponent(user.email)}&casesensitive=false`;
    const res=await fetch(url,{headers:{Authorization:`Bearer ${SHEETDB_API_TOKEN}`}});
    if(res.ok){
      const rows=await res.json();
      if(Array.isArray(rows)&&rows.length){
        const r=rows[0];
        if(r.baseAvailable) BASE_AVAILABLE=Number(r.baseAvailable);
        if(r.totalBalance) TOTAL_BALANCE=Number(r.totalBalance);
      }
    }
  }catch{}
}
function renderKPIs(){
  const spent = getTransfers().filter(t=>String(t.status||'').toLowerCase()==='completed').reduce((s,t)=>s+(Number(t.amount)||0),0);
  const available = Math.max(0, BASE_AVAILABLE - spent);
  const el=document.getElementById('kpiSection');
  el.innerHTML = `
    <div class="kpi"><div class="value">${currency(TOTAL_BALANCE)}</div><div class="muted">Total Balance</div></div>
    <div class="kpi"><div class="value">${currency(BASE_AVAILABLE)}</div><div class="muted">Base</div></div>
    <div class="kpi"><div class="value">${currency(spent)}</div><div class="muted">Spent</div></div>
    <div class="kpi"><div class="value">${currency(available)}</div><div class="muted">Available</div></div>`;
}
function getTransfers(){
  try{const arr=JSON.parse(sessionStorage.getItem('initiatedTransactions')||'[]');return Array.isArray(arr)?arr:[];}catch{return [];}
}
function renderAccounts(){
  const html = `
    <div class="account-row"><div><span class="pill">Checking</span>Everyday Checking</div><div>${currency(TOTAL_BALANCE)}</div></div>
    <div class="account-row"><div><span class="pill" style="background:#d1fae5;color:#047857;">Reserve</span>Savings Reserve</div><div>${currency(BASE_AVAILABLE)}</div></div>
  `;
  document.getElementById('accountsBody').innerHTML=html;
}
function renderTransfers(){
  const txs = getTransfers().slice().sort((a,b)=> (b.dateISO||'').localeCompare(a.dateISO||''));
  document.getElementById('txList').innerHTML = txs.length ? txs.map(t=>{
    const amt = Number(t.amount)||0;
    const delta = (amt>=0?'+':'')+currency(amt);
    const cls = amt>=0?'delta pos':'delta neg';
    return `<div class="tx" data-ref="${t.reference}">
      <div><strong>${t.reference}</strong><br><span style="color:#666;font-size:.7rem">${t.status||'Pending'}</span></div>
      <div class="${cls}">${delta}</div>
    </div>`;
  }).join('') : `<div style="text-align:center;color:#666;padding:16px 0">No transfers yet.</div>`;
}
(function init(){
  const uJSON=sessionStorage.getItem('loggedInUser');
  let user=null;
  try{user=JSON.parse(uJSON||'');}catch{}
  if(!user||user.isAuthenticated!==true){window.location.href='login.html';return;}
  document.getElementById('userWelcome').textContent=`Welcome, ${(user.name||user.fullname||user.email.split('@')[0])}`;
  loadBalances(user).then(()=>{renderKPIs();});
  renderAccounts();
  renderTransfers();
  // periodic refresh to recompute available
  setInterval(()=>{renderKPIs();renderTransfers();},15000);
})();
</script>
</body>
</html>