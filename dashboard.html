<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard • Shenzhenswift</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --brand:#1e3c72; --brand2:#2a5298; --accent1:#667eea; --accent2:#764ba2;
      --bg:#f6f7fb; --card:#ffffff; --text:#333; --muted:#666; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:linear-gradient(135deg,var(--brand) 0%,var(--brand2) 100%);color:#fff;padding:1rem 0;position:fixed;width:100%;top:0;z-index:1000;backdrop-filter:blur(10px)}
    nav{display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.6rem;font-weight:800;background:linear-gradient(45deg,#fff,#e0e7ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.3px}
    .nav-links{display:flex;list-style:none;gap:1.5rem}
    .nav-links a{color:#fff;text-decoration:none;transition:.3s;font-weight:600;position:relative}
    .nav-links a:hover{color:#e0e7ff;transform:translateY(-2px)}
    .btn{padding:10px 18px;border-radius:12px;text-decoration:none;font-weight:700;transition:.3s;border:2px solid transparent;cursor:pointer;position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;font-size:.95rem}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);transition:left .5s}
    .btn:hover::before{left:100%}
    .btn-primary{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:#fff;box-shadow:0 6px 20px rgba(118,75,162,.25)}
    .btn-action{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 6px 18px rgba(102,126,234,.28);font-weight:800}
    main{padding-top:96px}
    .page-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:18px 0 14px}
    .page-title{font-size:1.6rem;font-weight:800;color:var(--brand);letter-spacing:.2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar .search{width:320px;max-width:60vw;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    .grid{display:grid;gap:18px}
    @media (min-width:700px){.grid.cols-3{grid-template-columns:repeat(3,1fr)} .grid.cols-2{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .card h3{margin-bottom:8px;color:var(--brand);font-size:1.05rem}
    .kpi{display:flex;align-items:baseline;gap:10px}
    .kpi .value{font-size:1.8rem;font-weight:800}
    .kpi .muted{color:var(--muted);font-size:.9rem}
    .accounts{display:grid;gap:10px}
    .account-row{padding:12px;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:space-between;background:#fff}
    .account-row .left{display:flex;align-items:center;gap:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;color:var(--accent1);background:#eef2ff}
    .amount{font-weight:800}
    .tx-list{display:grid;gap:10px}
    .tx{display:grid;grid-template-columns:1fr auto;gap:6px 10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .tx .name{font-weight:700}
    .tx .meta{color:var(--muted);font-size:.9rem}
    .tx .delta.pos{color:#047857;font-weight:800}
    .tx .delta.neg{color:#b91c1c;font-weight:800}
    .footer-space{height:24px}
  </style>
</head>
<body>
  <script src="common.js"></script>
  <script>
// --- Added sync-enabled dashboard logic ---

let BASE_AVAILABLE=228503.55;
let TOTAL_BALANCE=228503.55;
let currentUser=null;
let syncIntervalId=null;

function currency(n){
  try{return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'});}catch{return '$'+n;}
}

function getLocalTransfers(){
  return Platform.getLocalTransfers ? Platform.getLocalTransfers() : [];
}

function saveLocalTransfers(list){
  if(Platform.saveLocalTransfers) Platform.saveLocalTransfers(list);
  else sessionStorage.setItem('initiatedTransactions', JSON.stringify(list));
}

async function loadUserFinancials(){
  if(!currentUser) return;
  try{
    const rows = await Platform.sheetSearch({formType:'Registration', email:currentUser.email});
    if(Array.isArray(rows)&&rows.length){
      const r=rows[0];
      BASE_AVAILABLE = Number(r.baseAvailable||0);
      TOTAL_BALANCE = Number(r.totalBalance||0);
    }
  }catch{}
}

function renderKPIs(){
  const spent = getLocalTransfers()
    .filter(t=>(t.status||'').toLowerCase()==='completed')
    .reduce((s,t)=>s+(Number(t.amount)||0),0);
  const available = Math.max(0, BASE_AVAILABLE - spent);
  kpiWrap.innerHTML = `
    <div class="card kpi"><div class="value">${currency(TOTAL_BALANCE)}</div><div class="label">Total</div></div>
    <div class="card kpi"><div class="value">${currency(BASE_AVAILABLE)}</div><div class="label">Base</div></div>
    <div class="card kpi"><div class="value">${currency(spent)}</div><div class="label">Spent</div></div>
    <div class="card kpi"><div class="value">${currency(available)}</div><div class="label">Available</div></div>`;
}

function renderAccounts(){
  accountsBody.innerHTML = `
    <div class="account-row"><div><span class="pill">CHK</span>Everyday Checking</div><div>${currency(TOTAL_BALANCE)}</div></div>
    <div class="account-row"><div><span class="pill" style="background:#d1fae5;color:#047857;">SAV</span>Savings Reserve</div><div>${currency(BASE_AVAILABLE)}</div></div>`;
}

function renderTransfers(){
  const list = getLocalTransfers().slice().sort((a,b)=>(b.dateISO||'').localeCompare(a.dateISO||''));
  txList.innerHTML = list.length ? list.slice(0,20).map(t=>{
    const amt=Number(t.amount)||0;
    const cls=amt>=0?'delta pos':'delta neg';
    return `<div class="tx" data-ref="${t.reference}">
      <div><strong>${t.reference}</strong><br><span style="color:#64748b">${t.status||'Pending'}</span></div>
      <div class="${cls}">${currency(amt)}</div>
    </div>`;
  }).join('') : `<div class="empty">No transfers yet.</div>`;
}

function mergeTransfers(remote){
  const local = getLocalTransfers();
  const map = new Map(local.map(t=>[t.reference,t]));
  remote.forEach(r=>{
    if(!r.reference) return;
    if(map.has(r.reference)){
      map.set(r.reference, {...map.get(r.reference), ...r});
    } else {
      map.set(r.reference, r);
    }
  });
  saveLocalTransfers(Array.from(map.values()));
}

async function syncTransfers(){
  if(!currentUser) return;
  try{
    const rows = await Platform.sheetSearch({formType:'Transfer', email: currentUser.email});
    if(Array.isArray(rows)){
      mergeTransfers(rows);
      renderTransfers();
      renderKPIs();
    }
  }catch{}
}

async function fullRefresh(){
  await loadUserFinancials();
  await syncTransfers();
  renderAccounts();
  renderKPIs();
}

function startAutoSync(){
  if(syncIntervalId) clearInterval(syncIntervalId);
  syncIntervalId = setInterval(syncTransfers, 30000); // 30s
}

(function init(){
  try{currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')||'null');}catch{}
  if(!currentUser || currentUser.isAuthenticated!==true){location.href='login.html';return;}
  welcomeLine.textContent=`Welcome, ${(currentUser.name||currentUser.fullname||currentUser.email.split('@')[0])}`;
  fullRefresh();
  startAutoSync();
  // UI refresh button (optional): press R key to force refresh
  document.addEventListener('keydown',e=>{
    if(e.key==='r' && (e.metaKey||e.ctrlKey)){
      e.preventDefault();
      fullRefresh();
    }
  });
  document.getElementById('logoutLink')?.addEventListener('click',()=>{
    sessionStorage.removeItem('loggedInUser');
  });
})();
  </script>
  <header>
    <div class="container">
      <nav>
        <div class="logo">Shenzhenswift</div>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="transfer.html">Transfer</a></li>
          <li><a href="#">Cards</a></li>
          <li><a href="#">Support</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <div>
          <div class="page-title">Dashboard</div>
          <div id="userNameLine" class="subtitle" style="margin-top:4px;"></div>
          <div style="color:var(--muted); margin-top:4px;">Overview of your accounts and recent activity</div>
        </div>
        <div class="toolbar">
          <input class="search" placeholder="Search transactions, accounts…">
          <a class="btn btn-primary" href="transfer.html">New transfer</a>
        </div>
      </div>

      <section class="grid cols-3" style="margin: 10px 0 8px;" id="kpiSection"></section>

      <section class="grid cols-2" style="margin-top: 8px;" id="accountSection"></section>

      <div class="footer-space"></div>
    </div>
  </main>

  <script>
  BASE_AVAILABLE = 221540.20; // default base Available KPI before deductions
  TOTAL_BALANCE = 256780.00; // default total balance

    // Gate: only logged-in, authenticated users (set by login/register after SheetDB confirm)
    const session = sessionStorage.getItem('loggedInUser');
    let user = null;
    try {
      user = JSON.parse(session || '{}');
      if (!user || user.isAuthenticated !== true) {
        window.location.href = 'index.html';
      }
    } catch {
      window.location.href = 'index.html';
    }

    function currency(n){ try{ return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'}) }catch{ return `$${n}` } }
    async function loadTransfers(){
      if(window.Platform && Platform.fetchTransfersUnified){
        return Platform.fetchTransfersUnified({ email: (user && user.email)||'' });
      }
      // fallback to session only
      try { const arr = JSON.parse(sessionStorage.getItem('initiatedTransactions')||'[]'); return Array.isArray(arr)?arr:[]; } catch { return []; }
    }

  async function loadUserBalances(){
    try {
      if(!user || !user.email) return;
      const res = await fetch(`http://localhost:3001/api/users/${encodeURIComponent(user.email)}`);
      if(!res.ok) return;
      const data = await res.json();
      if(data.baseAvailable) BASE_AVAILABLE = Number(data.baseAvailable);
      if(data.totalBalance) TOTAL_BALANCE = Number(data.totalBalance);
    } catch {}
  }

  window.addEventListener('DOMContentLoaded', async () => {
      // Welcome line
      const nameEl = document.getElementById('userNameLine');
      if (nameEl) {
        const displayName = (user && (user.name || user.fullname)) || (user && user.email ? user.email.split('@')[0] : 'User');
        nameEl.textContent = `Welcome, ${displayName}`;
      }

      await loadUserBalances();
      
  let txs = await loadTransfers();
      // Merge any locally initiated (session) that might not yet be in API/Sheet
      try {
        const local = JSON.parse(sessionStorage.getItem('initiatedTransactions')||'[]');
        if(Array.isArray(local)){
          const existingRefs = new Set(txs.map(t=>t.reference));
          for(const l of local){ if(l && l.reference && !existingRefs.has(l.reference)) txs.unshift(l); }
        }
      } catch {}

      // Available balance = base - sum of COMPLETED transfer amounts
  const spent = txs.filter(t => String(t.status||'').toLowerCase()==='completed').reduce((s,t)=> s + (Number(t.amount)||0),0);
      const availableNow = Math.max(0, BASE_AVAILABLE - spent);

      // KPIs
      const kpiSection = document.getElementById('kpiSection');
      kpiSection.innerHTML = `
        <div class="card">
          <h3>Total balance</h3>
          <div class="kpi"><div class="value">${currency(TOTAL_BALANCE)}</div><div class="muted">All accounts</div></div>
        </div>
        <div class="card">
          <h3>Available</h3>
          <div class="kpi"><div class="value">${currency(availableNow)}</div><div class="muted">After holds</div></div>
        </div>
        <div class="card">
          <h3>Month-to-date</h3>
          <div class="kpi"><div class="value">+$4,920.11</div><div class="muted">Net cash flow</div></div>
        </div>
      `;

      // Recent transactions (only from transfer page)
  const txListHtml = txs.length
        ? txs.map(t => {
            const date = t.date ? t.date : (t.dateISO ? new Date(t.dateISO).toLocaleDateString() : new Date().toLocaleDateString());
            const delta = t.delta || (t.amount ? '- ' + currency(t.amount) : '');
            const signClass = delta.trim().startsWith('+') ? 'pos' : 'neg';
            const name = t.name || t.type || 'Transfer';
            const meta = [
              date,
              t.network || 'Transfer',
              t.from ? t.from : null,
              t.to ? `→ ${t.to}` : null,
              t.status ? t.status : null
            ].filter(Boolean).join(' • ');
            const ref = encodeURIComponent(t.reference || t.ref || t.id || '');
            return `
              <div class="tx" data-ref="${ref}">
                <div class="name">${name}</div>
                <div class="delta ${signClass}">${delta}</div>
                <div class="meta">${meta}</div>
              </div>
            `;
          }).join('')
        : `<div style="color:var(--muted);text-align:center;padding:24px 0;">No recent transactions yet.</div>`;

      // Accounts + Recent transactions
      const accountSection = document.getElementById('accountSection');
      accountSection.innerHTML = `
        <div class="card">
          <h3>Your accounts</h3>
          <div class="accounts" style="margin-top:10px;">
            <div class="account-row">
              <div class="left">
                <span class="pill">Checking</span>
                <div>
                  <div style="font-weight:800;">Everyday Checking</div>
                  <div class="muted" style="font-size:.9rem;">••• 3482</div>
                </div>
              </div>
              <div class="amount">$24,380.22</div>
            </div>
            <div class="account-row">
              <div class="left">
                <span class="pill">Savings</span>
                <div>
                  <div style="font-weight:800;">High-Yield Savings</div>
                  <div class="muted" style="font-size:.9rem;">••• 9015</div>
                </div>
              </div>
              <div class="amount">$198,440.98</div>
            </div>
            <div class="account-row">
              <div class="left">
                <span class="pill">Brokerage</span>
                <div>
                  <div style="font-weight:800;">Invest Portfolio</div>
                  <div class="muted" style="font-size:.9rem;">••• 1170</div>
                </div>
              </div>
              <div class="amount">$33,958.80</div>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
            <a class="btn btn-primary" href="transfer.html">Transfer money</a>
            <button class="btn btn-action" type="button">Deposit funds</button>
            <button class="btn btn-action" type="button">Statements</button>
          </div>
        </div>
        <div class="card">
          <h3>Recent transactions</h3>
          <div class="tx-list" style="margin-top:10px;" id="txList">${txListHtml}</div>
          <div style="margin-top:12px;">
            <a class="btn btn-primary" id="viewDetailsBtn" href="transaction-details.html">View details</a>
          </div>
        </div>
      `;

      // Click a transaction row to open its details
      const listEl = document.getElementById('txList');
      if (listEl) {
        listEl.addEventListener('click', (e) => {
          const row = e.target.closest('.tx');
          if (!row) return;
          const ref = row.getAttribute('data-ref');
          if (ref) {
            window.location.href = `transaction-details.html?ref=${ref}`;
          }
        });
      }

      // “View details” opens most recent tx if present
      const btn = document.getElementById('viewDetailsBtn');
      if (btn && txs.length > 0) {
        const latestRef = encodeURIComponent(txs[0].reference || txs[0].ref || txs[0].id || '');
        btn.href = latestRef ? `transaction-details.html?ref=${latestRef}` : 'transaction-details.html';
      }

      // Real-time updates via SSE -> re-render recent transactions & KPIs
      const token = localStorage.getItem('api_token')||'';
      if(token){
        try {
          const src = new EventSource(`http://localhost:3001/api/stream?token=${encodeURIComponent(token)}`);
          const rebuilder = async () => {
            let fresh = await loadTransfers();
            try{ const local2 = JSON.parse(sessionStorage.getItem('initiatedTransactions')||'[]'); if(Array.isArray(local2)){ const existingRefs = new Set(fresh.map(t=>t.reference)); for(const l of local2){ if(l && l.reference && !existingRefs.has(l.reference)) fresh.unshift(l); } } }catch{}
            txs = fresh;
            // Recompute spent & available
            const spent2 = txs.filter(t => String(t.status||'').toLowerCase()==='completed').reduce((s,t)=> s + (Number(t.amount)||0),0);
            const availableNow2 = Math.max(0, BASE_AVAILABLE - spent2);
            document.getElementById('kpiSection').children[1].querySelector('.value').textContent = currency(availableNow2);
            // Update tx-list only (simple approach)
            const listEl2 = document.getElementById('txList');
            if(listEl2){
              listEl2.innerHTML = txs.length ? txs.slice(0, listEl2.children.length || 50).map(t => {
                const date = t.date ? t.date : (t.dateISO ? new Date(t.dateISO).toLocaleDateString() : new Date().toLocaleDateString());
                const delta = t.delta || (t.amount ? '- ' + currency(t.amount) : '');
                const signClass = delta.trim().startsWith('+') ? 'pos' : 'neg';
                const name = t.name || t.type || 'Transfer';
                const meta = [date, t.network || 'Transfer', t.from ? t.from : null, t.to ? `→ ${t.to}` : null, t.status ? t.status : null].filter(Boolean).join(' • ');
                const ref = encodeURIComponent(t.reference || t.ref || t.id || '');
                return `<div class="tx" data-ref="${ref}"><div class="name">${name}</div><div class="delta ${signClass}">${delta}</div><div class="meta">${meta}</div></div>`;
              }).join('') : `<div style="color:var(--muted);text-align:center;padding:24px 0;">No recent transactions yet.</div>`;
            }
          };
          src.addEventListener('transfer.created', rebuilder);
          src.addEventListener('transfer.updated', rebuilder);
        } catch {}
      }
    });
  </script>
</body>
</html>