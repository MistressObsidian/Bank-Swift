<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>All Accounts - Fidelity</title>
  <style>
    :root{
      --brand:#006341;
      --brand-dark:#004d2c;
      --bg:#f4f4f4;
      --text:#333;
      --muted:#888;
      --card:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text);
    }
    .container{ display:flex; min-height:100vh; }
    .sidebar{
      width: 300px; background:#e7e7e7; padding:20px; position:sticky; top:0; height:100vh; overflow:auto;
    }
    .sidebar h2{ font-size:18px; color:var(--brand); margin:0 0 8px; }
    .balance{
      font-size:28px; font-weight:bold; color:var(--brand); margin: 6px 0 16px;
    }
    .sidebar section{ margin-top:16px; }
    .sidebar h3{ font-size:15px; margin:10px 0; color:#222; }
    .account-list{ font-size:14px }
    .account-row{ display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #ddd; }
    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#dfeee8; color:var(--brand);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;
      background:var(--brand); color:white; transition:.2s background;
    }
    .btn:hover{ background:var(--brand-dark); }
    .btn-ghost{ background:#fff; color:var(--brand); border:1px solid #cfd7d3 }
    .stack-8 > *{ margin-right:8px }
    .stack-8 > *:last-child{ margin-right:0 }

    .main{ flex:1; padding:20px; background:#fff; }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:20px;
    }
    .header h2{ margin:0; }
    .right-actions{ display:flex; align-items:center; gap:10px }
    .search{
      width:320px; max-width:45vw; padding:10px 12px; border:1px solid #ccc; border-radius:6px; font-size:14px;
    }
    .filters{ margin:6px 0 18px; }
    .filters .btn{ padding:8px 12px; font-weight:500 }

    .card{
      background:var(--card); border:1px solid #e7e7e7; border-radius:10px; padding:16px;
      box-shadow: 0 1px 2px rgba(0,0,0,.03);
    }
    .welcome{ background:linear-gradient(135deg, var(--brand), var(--brand-dark)); color:#fff; border:none; }
    .welcome h3{ margin:0 0 6px; }
    .muted{ color:#e9f5ef; opacity:.9; }

    table{ width:100%; border-collapse:collapse }
    th, td{ padding:12px 10px; border-bottom:1px solid #eee; text-align:left; }
    th{ background:#f7f7f7; color:#222; font-weight:700 }
    td a{ text-decoration:none; font-weight:700 }
    .amt-pos{ color:green }
    .amt-neg{ color:#c62828 }

    .loader{
      display:inline-block; width:16px; height:16px; border-radius:50%;
      border:2px solid #cfe5db; border-top-color:#fff; margin-left:8px; animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .skeleton{
      background:linear-gradient(90deg,#eee,#f6f6f6,#eee);
      background-size:200% 100%;
      animation:skeleton 1.2s infinite;
      border-radius:6px;
    }
    @keyframes skeleton{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .row{ display:flex; gap:16px; flex-wrap:wrap }
    .col{ flex:1 1 320px }

    .topbar{
      position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid #eee; padding:10px 16px; display:none;
    }

    @media (max-width: 900px){
      .container{ flex-direction:column; }
      .sidebar{ width:100%; height:auto; position:relative }
      .main{ padding:16px }
      .search{ width:100% }
      .topbar{ display:block }
    }
  </style>
</head>
<body>
  <!-- Mobile topbar -->
  <div class="topbar row" id="topbarUser">
    <div class="col" style="flex:2 1 auto;">
      <strong>Welcome, <span id="tbUserName">User</span></strong>
    </div>
    <div class="col stack-8" style="justify-content:flex-end;">
      <button class="btn-ghost btn" id="logoutTop">Log out</button>
    </div>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2>All Accounts</h2>
      <div id="totalBalance" class="balance skeleton" style="height:36px; width:70%"></div>

      <section>
        <h3>Account Owner</h3>
        <div id="accountOwner" class="pill">Loading…</div>
      </section>

      <section>
        <h3>Accounts</h3>
        <div id="accountsList" class="account-list">
          <div class="account-row skeleton" style="height:20px"></div>
          <div class="account-row skeleton" style="height:20px"></div>
        </div>
      </section>

      <section>
        <button class="btn" id="transferBtn">Transfer Money</button>
      </section>

      <section style="margin-top:24px">
        <button class="btn-ghost btn" id="logoutBtn">Log out</button>
      </section>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="header">
        <h2>All Accounts</h2>
        <div class="right-actions">
          <input type="text" id="searchInput" class="search" placeholder="Search Activity & Orders" />
        </div>
      </div>

      <div class="card welcome" id="welcomeCard">
        <h3>Welcome back, <span id="welcomeName">User</span>!</h3>
        <div class="muted">Manage your accounts and transactions from your dashboard.</div>
      </div>

      <div class="filters" style="margin-top:16px">
        <div class="stack-8">
          <button class="btn" data-range="30">Past 30 Days</button>
          <button class="btn" data-range="90">Past 90 Days</button>
          <button class="btn" id="refreshBtn">Refresh<span class="loader" id="refreshSpin" style="display:none"></span></button>
        </div>
      </div>

      <section class="card" style="margin-top:12px">
        <h3 style="margin:0 0 10px">Recent Transactions</h3>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Account</th>
                <th>Description</th>
                <th>Type</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="txBody">
              <tr><td colspan="5"><div class="skeleton" style="height:18px"></div></td></tr>
              <tr><td colspan="5"><div class="skeleton" style="height:18px"></div></td></tr>
              <tr><td colspan="5"><div class="skeleton" style="height:18px"></div></td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    const SHEETDB_API_URL = "https://sheetdb.io/api/v1/3g36t35kn6po0";

    // --- Utilities ----------------------------------------------------------
    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
    const fmtMoney = (n) => {
      const num = typeof n === 'string' ? Number(n) : n;
      if (!isFinite(num)) return '$0.00';
      return num.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    };
    const safe = (v, d='') => (v===undefined || v===null ? d : v);

    // Build a /search URL for SheetDB
    function buildSearch(params){
      const usp = new URLSearchParams({...params, casesensitive: 'false'});
      return `${SHEETDB_API_URL}/search?${usp.toString()}`;
    }

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    // --- Data fetchers ------------------------------------------------------
    async function fetchAccountsByEmail(email){
      // formType=Account rows
      const url = buildSearch({ formType:'Account', email: email });
      return fetchJSON(url);
    }

    async function fetchTransactionsByEmail(email, options={}){
      const url = buildSearch({ formType:'Transaction', email: email });
      const rows = await fetchJSON(url);
      // optional: filter by last N days
      if (options.days){
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - options.days);
        return rows.filter(r => {
          const d = new Date(r.date || r.timestamp || Date.now());
          return d >= cutoff;
        });
      }
      return rows;
    }

    // --- Renderers ----------------------------------------------------------
    function renderAccounts(ownerName, accounts){
      // Total
      const total = accounts.reduce((sum, a) => sum + (Number(a.balance)||0), 0);
      qs('#totalBalance').classList.remove('skeleton');
      qs('#totalBalance').textContent = fmtMoney(total);

      // Owner
      qs('#accountOwner').textContent = ownerName || 'User';

      // List
      const wrap = qs('#accountsList');
      wrap.innerHTML = '';
      if (accounts.length === 0){
        wrap.innerHTML = '<div class="muted">No accounts yet.</div>';
        return;
      }
      accounts.forEach(a => {
        const row = document.createElement('div');
        row.className = 'account-row';
        row.innerHTML = `
          <span>${safe(a.accountType,'Account')} — <strong>${safe(a.accountName,'Unnamed')}</strong></span>
          <span>${fmtMoney(a.balance)}</span>
        `;
        wrap.appendChild(row);
      });
    }

    function renderTransactions(rows){
      const tbody = qs('#txBody');
      tbody.innerHTML = '';
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No recent transactions.</td></tr>`;
        return;
      }
      // sort desc by date
      rows.sort((a,b) => new Date(b.date||b.timestamp||0) - new Date(a.date||a.timestamp||0));
      rows.slice(0, 50).forEach(tx => {
        const amt = Number(tx.amount);
        const cls = amt < 0 ? 'amt-neg' : 'amt-pos';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${safe(tx.date, new Date().toLocaleDateString())}</td>
          <td>${safe(tx.account, '—')}</td>
          <td>${safe(tx.description,'—')}</td>
          <td>${safe(tx.type,'—')}</td>
          <td><a href="#" class="${cls}">${amt < 0 ? '-' : '+'}${fmtMoney(Math.abs(amt))}</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Session / Auth -----------------------------------------------------
    function requireSession(){
      const s = sessionStorage.getItem('loggedInUser');
      if (!s){
        window.location.href = 'index.html';
        return null;
      }
      try { return JSON.parse(s); } catch { return null; }
    }

    // --- Initialization -----------------------------------------------------
    async function initDashboard(){
      const user = requireSession();
      if (!user) return;

      // Welcome & topbar
      qs('#welcomeName').textContent = user.name || 'User';
      qs('#tbUserName').textContent = user.name || 'User';
      qs('#accountOwner').textContent = user.name || 'User';

      // Buttons
      qs('#transferBtn').addEventListener('click', () => window.location.href='transfer.html');
      const doLogout = () => { sessionStorage.removeItem('loggedInUser'); window.location.href='index.html'; };
      qs('#logoutBtn').addEventListener('click', doLogout);
      qs('#logoutTop').addEventListener('click', doLogout);

      // Load accounts & transactions
      await loadData(user.email);
      // Refresh handler
      qs('#refreshBtn').addEventListener('click', async () => {
        qs('#refreshSpin').style.display = 'inline-block';
        try { await loadData(user.email); }
        finally { qs('#refreshSpin').style.display = 'none'; }
      });

      // Simple search filter (client-side)
      qs('#searchInput').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        qsa('#txBody tr').forEach(tr => {
          const txt = tr.textContent.toLowerCase();
          tr.style.display = txt.includes(term) ? '' : 'none';
        });
      });
    }

    async function loadData(email){
      // Fetch accounts
      let accounts = [];
      try {
        accounts = await fetchAccountsByEmail(email);
      } catch (e) {
        console.error('Accounts fetch failed', e);
      }

      // If no account rows exist, show a sane default (non-persistent)
      if (!accounts || accounts.length === 0){
        accounts = [
          { accountType:'Individual - TOD', accountName:'Core Position', balance: 6835.77 },
          { accountType:'Managed', accountName:`${email.split('@')[0]}'s Investment`, balance: 256456.56 }
        ];
      }

      renderAccounts(email, accounts);

      // Fetch transactions (last 90 days by default)
      let txs = [];
      try {
        txs = await fetchTransactionsByEmail(email, { days: 90 });
      } catch (e) {
        console.error('Transactions fetch failed', e);
      }

      renderTransactions(txs);
    }

    // Kickoff
    window.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
