<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard • Shenzhenswift</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --brand:#1e3c72; --brand2:#2a5298; --accent1:#667eea; --accent2:#764ba2;
      --bg:#f6f7fb; --card:#ffffff; --text:#333; --muted:#666; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:linear-gradient(135deg,var(--brand) 0%,var(--brand2) 100%);color:#fff;padding:1rem 0;position:fixed;width:100%;top:0;z-index:1000;backdrop-filter:blur(10px)}
    nav{display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.6rem;font-weight:800;background:linear-gradient(45deg,#fff,#e0e7ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.3px}
    .nav-links{display:flex;list-style:none;gap:1.5rem}
    .nav-links a{color:#fff;text-decoration:none;transition:.3s;font-weight:600;position:relative}
    .nav-links a:hover{color:#e0e7ff;transform:translateY(-2px)}
    .btn{padding:10px 18px;border-radius:12px;text-decoration:none;font-weight:700;transition:.3s;border:2px solid transparent;cursor:pointer;position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;font-size:.95rem}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);transition:left .5s}
    .btn:hover::before{left:100%}
    .btn-primary{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:#fff;box-shadow:0 6px 20px rgba(118,75,162,.25)}
    .btn-action{background:linear-gradient(45deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 6px 18px rgba(102,126,234,.28);font-weight:800}
    .btn-secondary{background:transparent;color:#fff;border:2px solid #fff}
    .btn-secondary:hover{background:#fff;color:var(--brand)}
    main{padding-top:96px}
    .page-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:18px 0 14px}
    .page-title{font-size:1.6rem;font-weight:800;color:var(--brand);letter-spacing:.2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar .search{width:320px;max-width:60vw;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    .grid{display:grid;gap:18px}
    @media (min-width:700px){.grid.cols-3{grid-template-columns:repeat(3,1fr)} .grid.cols-2{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .card h3{margin-bottom:8px;color:var(--brand);font-size:1.05rem}
    .kpi{display:flex;align-items:baseline;gap:10px}
    .kpi .value{font-size:1.8rem;font-weight:800}
    .kpi .muted{color:var(--muted);font-size:.9rem}
    .accounts{display:grid;gap:10px}
    .account-row{padding:12px;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:space-between;background:#fff}
    .account-row .left{display:flex;align-items:center;gap:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;color:var(--accent1);background:#eef2ff}
    .amount{font-weight:800}
    .tx-list{display:grid;gap:10px}
    .tx{display:grid;grid-template-columns:1fr auto;gap:6px 10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer}
    .tx .name{font-weight:700}
    .tx .meta{color:var(--muted);font-size:.9rem}
    .tx .delta.pos{color:#047857;font-weight:800}
    .tx .delta.neg{color:#b91c1c;font-weight:800}
    .footer-space{height:24px}
    .sync-indicator{position:fixed;bottom:20px;right:20px;padding:8px 12px;background:rgba(255,255,255,0.9);border-radius:20px;font-size:12px;color:#666;display:none;align-items:center;gap:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .sync-indicator.active{display:flex}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:#28a745;animation:pulse 2s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
  </style>
</head>
<body>
  <script src="common.js"></script>
  
  <header>
    <div class="container">
      <nav>
        <div class="logo">Shenzhenswift</div>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="transfer.html">Transfer</a></li>
          <li><a href="#">Cards</a></li>
          <li><a href="#">Support</a></li>
        </ul>
        <div class="auth-buttons">
          <a href="#" class="btn btn-secondary" onclick="logout()">Logout</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <div>
          <div class="page-title">Dashboard</div>
          <div id="userNameLine" class="subtitle" style="margin-top:4px;"></div>
          <div style="color:var(--muted); margin-top:4px;">Overview of your accounts and recent activity</div>
        </div>
        <div class="toolbar">
          <input class="search" placeholder="Search transactions, accounts…" id="searchInput">
          <a class="btn btn-primary" href="transfer.html">New transfer</a>
        </div>
      </div>

      <section class="grid cols-3" style="margin: 10px 0 8px;" id="kpiSection">
        <div class="card">
          <h3>Total balance</h3>
          <div class="kpi"><div class="value" id="totalBalanceValue">$0.00</div><div class="muted">All accounts</div></div>
        </div>
        <div class="card">
          <h3>Available</h3>
          <div class="kpi"><div class="value" id="availableValue">$0.00</div><div class="muted">After holds</div></div>
        </div>
        <div class="card">
          <h3>Pending</h3>
          <div class="kpi"><div class="value" id="pendingValue">$0.00</div><div class="muted">In process</div></div>
        </div>
      </section>

      <section class="grid cols-2" style="margin-top: 8px;" id="accountSection">
        <div class="card">
          <h3>Your accounts</h3>
          <div class="accounts" style="margin-top:10px;" id="accountsList">
            <div class="account-row">
              <div class="left">
                <span class="pill">Checking</span>
                <div>
                  <div style="font-weight:800;">Everyday Checking</div>
                  <div class="muted" style="font-size:.9rem;">••• 3482</div>
                </div>
              </div>
              <div class="amount" id="checkingBalance">$0.00</div>
            </div>
            <div class="account-row">
              <div class="left">
                <span class="pill" style="background:#d1fae5;color:#047857;">Savings</span>
                <div>
                  <div style="font-weight:800;">High-Yield Savings</div>
                  <div class="muted" style="font-size:.9rem;">••• 9015</div>
                </div>
              </div>
              <div class="amount" id="savingsBalance">$0.00</div>
            </div>
            <div class="account-row">
              <div class="left">
                <span class="pill" style="background:#fef3c7;color:#92400e;">Brokerage</span>
                <div>
                  <div style="font-weight:800;">Invest Portfolio</div>
                  <div class="muted" style="font-size:.9rem;">••• 1170</div>
                </div>
              </div>
              <div class="amount" id="brokerageBalance">$0.00</div>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
            <a class="btn btn-primary" href="transfer.html">Transfer money</a>
            <button class="btn btn-action" type="button" onclick="alert('Feature coming soon!')">Deposit funds</button>
            <button class="btn btn-action" type="button" onclick="window.print()">Statements</button>
          </div>
        </div>
        <div class="card">
          <h3>Recent transactions</h3>
          <div class="tx-list" style="margin-top:10px;" id="txList">
            <div style="color:var(--muted);text-align:center;padding:24px 0;">Loading transactions...</div>
          </div>
          <div style="margin-top:12px;">
            <a class="btn btn-primary" id="viewDetailsBtn" href="transaction-details.html">View all transactions</a>
          </div>
        </div>
      </section>

      <div class="footer-space"></div>
    </div>
  </main>

  <div class="sync-indicator" id="syncIndicator">
    <div class="sync-dot"></div>
    <span>Syncing...</span>
  </div>

  <script>
    // Default financial values
    const DEFAULT_BASE_AVAILABLE = 221540.20;
    const DEFAULT_TOTAL_BALANCE = 256780.00;
    
    let currentUser = null;
    let userFinancials = {
      baseAvailable: DEFAULT_BASE_AVAILABLE,
      totalBalance: DEFAULT_TOTAL_BALANCE
    };
    let allTransfers = [];
    let syncInterval = null;

    function currency(n) {
      try {
        return Number(n).toLocaleString(undefined, {style:'currency', currency:'USD'});
      } catch {
        return `$${n}`;
      }
    }

    function logout() {
      sessionStorage.removeItem('loggedInUser');
      sessionStorage.removeItem('initiatedTransactions');
      window.location.href = 'index.html';
    }

    async function loadUserFinancials() {
      if (!currentUser || !currentUser.email) return;
      
      try {
        userFinancials = await Platform.fetchUserFinancials(currentUser.email);
      } catch (e) {
        console.log('Using default financials');
        userFinancials = {
          baseAvailable: DEFAULT_BASE_AVAILABLE,
          totalBalance: DEFAULT_TOTAL_BALANCE
        };
      }
    }

    async function loadTransfers() {
      if (!currentUser || !currentUser.email) return;
      
      showSyncIndicator();
      
      try {
        // Sync all transfers (local + remote)
        allTransfers = await Platform.syncAllTransfers();
        
        // Filter for current user
        allTransfers = allTransfers.filter(t => 
          !t.email || t.email === currentUser.email
        );
        
        // Sort by date (newest first)
        allTransfers.sort((a, b) => {
          const dateA = new Date(a.dateISO || a.date || 0);
          const dateB = new Date(b.dateISO || b.date || 0);
          return dateB - dateA;
        });
      } catch (e) {
        console.error('Failed to load transfers:', e);
        allTransfers = Platform.getLocalTransfers();
      }
      
      hideSyncIndicator();
    }

    function calculateBalances() {
      // Calculate spent and pending amounts
      const spent = allTransfers
        .filter(t => String(t.status || '').toLowerCase() === 'completed')
        .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
      
      const pending = allTransfers
        .filter(t => String(t.status || '').toLowerCase() === 'pending')
        .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
      
      const available = Math.max(0, userFinancials.baseAvailable - spent - pending);
      
      return { spent, pending, available };
    }

    function updateKPIs() {
      const { spent, pending, available } = calculateBalances();
      
      document.getElementById('totalBalanceValue').textContent = currency(userFinancials.totalBalance);
      document.getElementById('availableValue').textContent = currency(available);
      document.getElementById('pendingValue').textContent = currency(pending);
    }

    function updateAccounts() {
      const { available } = calculateBalances();
      
      // Distribute balance across accounts (example distribution)
      const checkingBalance = available * 0.3;
      const savingsBalance = available * 0.6;
      const brokerageBalance = available * 0.1;
      
      document.getElementById('checkingBalance').textContent = currency(checkingBalance);
      document.getElementById('savingsBalance').textContent = currency(savingsBalance);
      document.getElementById('brokerageBalance').textContent = currency(brokerageBalance);
    }

    function renderTransfers() {
      const txList = document.getElementById('txList');
      
      if (allTransfers.length === 0) {
        txList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:24px 0;">No transactions yet.</div>';
        return;
      }
      
      // Show only recent 10 transactions
      const recentTransfers = allTransfers.slice(0, 10);
      
      txList.innerHTML = recentTransfers.map(t => {
        const date = t.dateISO ? new Date(t.dateISO).toLocaleDateString() : 'Today';
        const amount = Number(t.amount) || 0;
        const delta = amount > 0 ? `+${currency(amount)}` : `-${currency(Math.abs(amount))}`;
        const deltaClass = amount >= 0 ? 'pos' : 'neg';
        const name = t.network || t.type || 'Transfer';
        const status = t.status || 'Pending';
        const statusColor = status.toLowerCase() === 'completed' ? '#047857' : '#b45309';
        
        const meta = [
          date,
          t.from ? `From: ${t.from}` : null,
          t.to ? `To: ${t.to}` : null,
          `<span style="color:${statusColor};font-weight:600">${status}</span>`
        ].filter(Boolean).join(' • ');
        
        return `
          <div class="tx" data-ref="${t.reference || ''}" onclick="viewTransaction('${t.reference || ''}')">
            <div>
              <div class="name">${name}</div>
              <div class="meta">${meta}</div>
            </div>
            <div class="delta ${deltaClass}">${delta}</div>
          </div>
        `;
      }).join('');
      
      // Update view details button
      if (recentTransfers.length > 0) {
        const latestRef = recentTransfers[0].reference;
        if (latestRef) {
          document.getElementById('viewDetailsBtn').href = `transaction-details.html?ref=${encodeURIComponent(latestRef)}`;
        }
      }
    }

    function viewTransaction(ref) {
      if (ref) {
        window.location.href = `transaction-details.html?ref=${encodeURIComponent(ref)}`;
      }
    }

    function showSyncIndicator() {
      document.getElementById('syncIndicator').classList.add('active');
    }

    function hideSyncIndicator() {
      setTimeout(() => {
        document.getElementById('syncIndicator').classList.remove('active');
      }, 500);
    }

    async function refreshDashboard() {
      await loadUserFinancials();
      await loadTransfers();
      updateKPIs();
      updateAccounts();
      renderTransfers();
    }

    function startAutoSync() {
      // Clear any existing interval
      if (syncInterval) clearInterval(syncInterval);
      
      // Sync every 30 seconds
      syncInterval = setInterval(() => {
        refreshDashboard();
      }, 30000);
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      
      if (!query) {
        renderTransfers();
        return;
      }
      
      const filtered = allTransfers.filter(t => {
        const searchable = [
          t.reference,
          t.from,
          t.to,
          t.network,
          t.type,
          t.status,
          String(t.amount)
        ].filter(Boolean).join(' ').toLowerCase();
        
        return searchable.includes(query);
      });
      
      const txList = document.getElementById('txList');
      
      if (filtered.length === 0) {
        txList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:24px 0;">No matching transactions found.</div>';
        return;
      }
      
      txList.innerHTML = filtered.slice(0, 10).map(t => {
        const date = t.dateISO ? new Date(t.dateISO).toLocaleDateString() : 'Today';
        const amount = Number(t.amount) || 0;
        const delta = amount > 0 ? `+${currency(amount)}` : `-${currency(Math.abs(amount))}`;
        const deltaClass = amount >= 0 ? 'pos' : 'neg';
        const name = t.network || t.type || 'Transfer';
        const status = t.status || 'Pending';
        const statusColor = status.toLowerCase() === 'completed' ? '#047857' : '#b45309';
        
        const meta = [
          date,
          t.from ? `From: ${t.from}` : null,
          t.to ? `To: ${t.to}` : null,
          `<span style="color:${statusColor};font-weight:600">${status}</span>`
        ].filter(Boolean).join(' • ');
        
        return `
          <div class="tx" data-ref="${t.reference || ''}" onclick="viewTransaction('${t.reference || ''}')">
            <div>
              <div class="name">${name}</div>
              <div class="meta">${meta}</div>
            </div>
            <div class="delta ${deltaClass}">${delta}</div>
          </div>
        `;
      }).join('');
    });

    // Initialize dashboard
    window.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      if (!Platform.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = Platform.getUser();
      
      // Display user name
      const nameEl = document.getElementById('userNameLine');
      if (nameEl && currentUser) {
        const displayName = currentUser.name || currentUser.fullname || currentUser.email?.split('@')[0] || 'User';
        nameEl.textContent = `Welcome, ${displayName}`;
      }
      
      // Load and display data
      await refreshDashboard();
      
      // Start auto-sync
      startAutoSync();
      
      // Refresh on visibility change
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          refreshDashboard();
        }
      });
    });

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      if (syncInterval) clearInterval(syncInterval);
    });
  </script>
</body>
</html>